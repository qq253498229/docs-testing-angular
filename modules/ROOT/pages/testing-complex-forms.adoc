= æµ‹è¯•å¤æ‚è¡¨å•

å­¦ä¹ ç›®æ ‡

- åœ¨ç»„ä»¶æµ‹è¯•ä¸­å¡«å†™å’Œæäº¤è¡¨å•
- æµ‹è¯•åŒæ­¥å’Œå¼‚æ­¥å­—æ®µéªŒè¯å’Œé”™è¯¯æ¶ˆæ¯
- æµ‹è¯•åŠ¨æ€è¡¨å•é€»è¾‘
- ä½¿ç”¨å·¥å…·ç¡®ä¿è¡¨å•å¯¹æ‰€æœ‰äººéƒ½æ˜¯å¯è®¿é—®çš„

è¡¨å•æ˜¯å¤§å‹ Web åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒã€‚ç‰¹åˆ«æ˜¯ä¼ä¸šåº”ç”¨ç¨‹åºå›´ç»•é€šè¿‡è¡¨å•è¾“å…¥å’Œç¼–è¾‘æ•°æ®å±•å¼€ã€‚å› æ­¤ï¼Œå®ç°å¤æ‚è¡¨å•æ˜¯ Angular æ¡†æ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ã€‚

æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•åœ¨æµ‹è¯•è®¡æ•°å™¨ç»„ä»¶æ—¶ <<testing-components#_å¡«å……è¡¨å•, å¡«å†™è¡¨å•å­—æ®µ>>ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¼€å‘äº† setFieldValue æµ‹è¯•è¾…åŠ©å‡½æ•°ã€‚

æˆ‘ä»¬å¤„ç†çš„ç®€å•è¡¨å•æ—¨åœ¨è¾“å…¥ä¸€ä¸ªå€¼ã€‚æˆ‘ä»¬é€šè¿‡å¡«å†™å­—æ®µå¹¶æäº¤è¡¨å•æ¥è¿›è¡Œæµ‹è¯•ã€‚ç°åœ¨æˆ‘ä»¬å°†çœ‹ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ã€‚

TIP: æ³¨å†Œè¡¨å•

æˆ‘ä»¬å°†å¼•å…¥å’Œæµ‹è¯•ä¸€ä¸ªè™šæ„åœ¨çº¿æœåŠ¡çš„**æ³¨å†Œè¡¨å•**ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing[æ³¨å†Œè¡¨å•ï¼šæºä»£ç ]
- https://molily.github.io/angular-form-testing/[æ³¨å†Œè¡¨å•ï¼šè¿è¡Œåº”ç”¨ç¨‹åº]
====

++++
<button class="load-iframe">
See the sign-up form in action
</button>

<script type="text/x-template">
<p class="responsive-iframe">
<iframe src="https://molily.github.io/angular-form-testing/" class="responsive-iframe__iframe"></iframe>
</p>
</script>
++++

æ³¨å†Œè¡¨å•çš„åŠŸèƒ½åŒ…æ‹¬ï¼š

- ä¸åŒç±»å‹çš„è¾“å…¥å­—æ®µï¼šæ–‡æœ¬ã€å•é€‰æŒ‰é’®ã€å¤é€‰æ¡†ã€ä¸‹æ‹‰æ¡†
- åŒæ­¥å’Œå¼‚æ­¥éªŒè¯å™¨çš„å­—æ®µéªŒè¯
- å¯è®¿é—®çš„è¡¨å•ç»“æ„ã€å­—æ®µæ ‡ç­¾å’Œé”™è¯¯æ¶ˆæ¯
- å­—æ®µä¹‹é—´çš„åŠ¨æ€å…³è”

è¯¥è¡¨å•åŒ…å«å››ä¸ªéƒ¨åˆ†ï¼š

1. è®¡åˆ’é€‰æ‹©ï¼šâ€œä¸ªäººâ€ã€â€œå•†ä¸šâ€æˆ–â€œæ•™è‚²åŠéè¥åˆ©â€
2. ç™»å½•å‡­æ®ï¼šç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç 
3. è´¦å•åœ°å€
4. æœåŠ¡æ¡æ¬¾å’Œæäº¤æŒ‰é’®

TIP: éå®ç”¨æ€§

è¯·æ³¨æ„ï¼Œæ­¤è¡¨å•ä»…ç”¨äºæ¼”ç¤ºç›®çš„ã€‚è™½ç„¶å®ƒéµå¾ªäº†éªŒè¯å’Œå¯è®¿é—®æ€§çš„æœ€ä½³å®è·µï¼Œä½†ä»è®¾è®¡å’Œç”¨æˆ·ä½“éªŒçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¹¶ä¸å®ç”¨ã€‚å…¶ä¸­åŒ…æ‹¬ï¼Œå¯¹äºæ–°ç”¨æˆ·æ¥è¯´è¿‡äºå¤æ‚ã€‚

TIP: å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨

ä¸å…¶ä»–ç¤ºä¾‹å­˜å‚¨åº“ä¸åŒï¼Œè¿™ä¸ªç¤ºä¾‹è¢«åˆ†æˆäº†ä¸€ä¸ª `å®¢æˆ·ç«¯` ç›®å½•å’Œä¸€ä¸ª `æœåŠ¡å™¨` ç›®å½•ï¼š

- The https://github.com/molily/angular-form-testing/tree/main/client[``å®¢æˆ·ç«¯``ç›®å½•]åŒ…å«ä½¿ç”¨ Angular CLI åˆ›å»ºçš„æ ‡å‡† Angular åº”ç”¨ç¨‹åºã€‚
- The https://github.com/molily/angular-form-testing/tree/main/server[``æœåŠ¡å™¨``ç›®å½•]åŒ…å«ä¸€ä¸ªç®€å•çš„ Node.js æœåŠ¡ï¼Œæ¨¡æ‹Ÿç”¨æˆ·ç®¡ç†å’Œè´¦æˆ·åˆ›å»ºã€‚

åŒæ ·ï¼ŒNode.js æœåŠ¡ä»…ç”¨äºæ¼”ç¤ºç›®çš„ã€‚è¯¥æœåŠ¡å°†åˆ›å»ºçš„ç”¨æˆ·å¸æˆ·ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶åœ¨åœæ­¢æ—¶ä¸¢å¼ƒã€‚è¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚

å°½ç®¡æ³¨å†Œè¡¨å•åªæœ‰12ä¸ªè¡¨å•æ§ä»¶ï¼Œå¹¶ä¸ç‰¹åˆ«å¤§ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†è¦æ¢ç´¢ä¸€äº›å¾®å¦™çš„ç»†èŠ‚ã€‚

== æ³¨å†Œè¡¨å•ç»„ä»¶

è¡¨å•é€»è¾‘ä½äº https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.ts[`SignupFormComponent`] ä¸­ã€‚è¯¥ç»„ä»¶ä¾èµ–äº https://github.com/molily/angular-form-testing/blob/main/client/src/app/services/signup.service.ts[`SignupService`] ä¸åç«¯æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚

æ‚¨å¯èƒ½è®°å¾—ï¼Œåœ¨ Angular ä¸­ï¼Œæœ‰ä¸¤ç§åŸºæœ¬çš„è¡¨å•æ–¹æ³•ï¼š__æ¨¡æ¿é©±åŠ¨è¡¨å•__å’Œ__å“åº”å¼è¡¨å•__ã€‚

è™½ç„¶è¿™ä¸¤ç§æ–¹æ³•åœ¨å®è·µä¸­çœ‹èµ·æ¥éå¸¸ä¸åŒï¼Œä½†å®ƒä»¬åŸºäºç›¸åŒçš„åŸºæœ¬æ¦‚å¿µï¼šè¡¨å•ç»„ï¼ˆ`FormGroup` å¯¹è±¡ï¼‰å’Œè¡¨å•æ§ä»¶ï¼ˆ`FormControl` å¯¹è±¡ï¼‰ã€‚

TIP: å“åº”å¼è¡¨å•

`SignupFormComponent` æ˜¯ä¸€ä¸ª**å“åº”å¼è¡¨å•**ï¼Œå®ƒåœ¨ç»„ä»¶ç±»ä¸­æ˜¾å¼åˆ›å»ºç»„å’Œæ§ä»¶ã€‚è¿™æ ·ï¼Œæ›´å®¹æ˜“æŒ‡å®šè‡ªå®šä¹‰éªŒè¯å™¨å¹¶è®¾ç½®åŠ¨æ€å­—æ®µå…³è”ã€‚

ä¸å…¶ä»– Angular æ ¸å¿ƒæ¦‚å¿µä¸€æ ·ï¼Œæœ¬æŒ‡å—å‡å®šæ‚¨å¯¹å“åº”å¼è¡¨å•æœ‰åŸºæœ¬çš„äº†è§£ã€‚è¯·å‚è€ƒ https://angular.cn/guide/reactive-forms[å®˜æ–¹çš„å“åº”å¼è¡¨å•æŒ‡å—]ä»¥åŠ æ·±æ‚¨çš„çŸ¥è¯†ã€‚

`SignupFormComponent` ç±»çš„é‡è¦éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,typescript]
----
@Component({
  selector: 'app-signup-form',
  templateUrl: './signup-form.component.html',
  styleUrls: ['./signup-form.component.scss'],
})
export class SignupFormComponent {
  /* â€¦ */
  public form = this.formBuilder.group({
    plan: ['personal', required],
    username: [
      null,
      [required, pattern('[a-zA-Z0-9.]+'), maxLength(50)],
      (control: AbstractControl) =>
        this.validateUsername(control.value),
    ],
    email: [
      null,
      [required, email, maxLength(100)],
      (control: AbstractControl) =>
        this.validateEmail(control.value),
    ],
    password: [
      null,
      required,
      () => this.validatePassword()
    ],
    tos: [null, requiredTrue],
    address: this.formBuilder.group({
      name: [null, required],
      addressLine1: [null],
      addressLine2: [null, required],
      city: [null, required],
      postcode: [null, required],
      region: [null],
      country: [null, required],
    }),
  });
  /* â€¦ */
  constructor(
    private signupService: SignupService,
    private formBuilder: FormBuilder) {
    /* â€¦ */
  }
  /* â€¦ */
}
----

TIP: Form groups and controls

ä½¿ç”¨Angularçš„ https://angular.cn/guide/reactive-forms#using-the-formbuilder-service-to-generate-controls[FormBuilder]ï¼Œæˆ‘ä»¬åˆ›å»ºäº†``form``å±æ€§ï¼Œå³æœ€é¡¶å±‚çš„è¡¨å•ç»„ã€‚å†…éƒ¨æœ‰å¦ä¸€ä¸ªç”¨äºåœ°å€ç›¸å…³å­—æ®µçš„è¡¨å•ç»„ã€‚

è¡¨å•æ§ä»¶é€šè¿‡æŒ‡å®šå…¶åˆå§‹å€¼å’ŒéªŒè¯å™¨è¿›è¡Œå£°æ˜ã€‚ä¾‹å¦‚ï¼Œå¯†ç æ§ä»¶ï¼š

[source,typescript]
----
password: [
  // The initial value (null means empty)
  null,
  // The synchronous validator
  required,
  // The asynchronous validator
  () => this.validatePassword()
],
----

https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.html[`SignupFormComponent` æ¨¡æ¿] ä½¿ç”¨``formGroup``ã€``formGroupName``å’Œ``formControlName``æŒ‡ä»¤åˆ†åˆ«å°†å…ƒç´ ä¸è¡¨å•ç»„æˆ–æ§ä»¶å…³è”èµ·æ¥ã€‚

åªæœ‰ä¸€ä¸ªæ§ä»¶çš„ç®€åŒ–è¡¨å•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,html]
----
<form [formGroup]="form">
  <fieldset formGroupName="address">
    <label>
      Full name
      <input type="text" formControlName="name" />
    </label>
  </fieldset>
</form>
----

TIP: è¡¨å•æäº¤

å½“è¡¨å•å¡«å†™æ­£ç¡®ä¸”æ‰€æœ‰éªŒè¯é€šè¿‡æ—¶ï¼Œç”¨æˆ·å¯ä»¥æäº¤è¡¨å•ã€‚å®ƒä¼šç”Ÿæˆä¸€ä¸ªç”± https://github.com/molily/angular-form-testing/blob/main/client/src/app/services/signup.service.ts[``SignupData``æ¥å£]æè¿°çš„å¯¹è±¡ï¼š

[source,typescript]
----
export interface SignupData {
  plan: Plan;
  username: string;
  email: string;
  password: string;
  tos: true;
  address: {
    name: string;
    addressLine1?: string;
    addressLine2: string;
    city: string;
    postcode: string;
    region?: string;
    country: string;
  };
}
----

``Plan``æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„è”åˆç±»å‹ï¼š

[source,typescript]
----
export type Plan = 'personal' | 'business' | 'non-profit';
----

SignupService``çš„``signup``æ–¹æ³•æ¥å—``SignupData``å¹¶å°†å…¶å‘é€åˆ°æœåŠ¡å™¨ã€‚å‡ºäºå®‰å…¨åŸå› ï¼ŒæœåŠ¡å™¨å†æ¬¡éªŒè¯æ•°æ®ã€‚ä½†åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºå‰ç«¯ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/[SignupFormComponentï¼šå®Œæ•´ä»£ç ]
- https://angular.cn/guide/reactive-forms[Angularæ–‡æ¡£ï¼šå“åº”å¼è¡¨å•]
====

== è¡¨å•éªŒè¯å’Œé”™è¯¯

TIP: åŒæ­¥éªŒè¯å™¨

å‡ ä¸ªè¡¨å•æ§ä»¶å…·æœ‰åŒæ­¥éªŒè¯å™¨ã€‚`required`ã€`email`ã€`maxLength`ã€``pattern``ç­‰éƒ½æ˜¯Angularæä¾›çš„å†…ç½®åŒæ­¥éªŒè¯å™¨ï¼š

[source,typescript]
----
import { Validators } from '@angular/forms';

const {
  email, maxLength, pattern, required, requiredTrue
} = Validators;
----

è¿™äº›éªŒè¯å™¨æ¥å—æ§ä»¶å€¼ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«å¯èƒ½çš„é”™è¯¯æ¶ˆæ¯çš„``ValidationErrors``å¯¹è±¡ã€‚éªŒè¯åœ¨å®¢æˆ·ç«¯åŒæ­¥è¿›è¡Œã€‚

TIP: å¼‚æ­¥éªŒè¯å™¨

å¯¹äºç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç ï¼Œå­˜åœ¨è‡ªå®šä¹‰çš„å¼‚æ­¥éªŒè¯å™¨ã€‚å®ƒä»¬æ£€æŸ¥ç”¨æˆ·åå’Œç”µå­é‚®ä»¶æ˜¯å¦å¯ç”¨ï¼Œä»¥åŠå¯†ç æ˜¯å¦è¶³å¤Ÿå¼ºå¤§ã€‚

å¼‚æ­¥éªŒè¯å™¨ä½¿ç”¨ `SignupService` ä¸åç«¯æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚è¿™äº›HTTPè¯·æ±‚ä½¿éªŒè¯å˜æˆäº†å¼‚æ­¥æ“ä½œã€‚

TIP: é”™è¯¯å‘ˆç°

å½“éªŒè¯å™¨è¿”å›ä»»ä½•é”™è¯¯æ—¶ï¼Œç›¸åº”çš„é”™è¯¯æ¶ˆæ¯ä¼šæ˜¾ç¤ºåœ¨è¡¨å•æ§ä»¶ä¸‹æ–¹ã€‚è¿™ä¸ªé‡å¤çš„ä»»åŠ¡è¢«å¤–åŒ…ç»™å¦ä¸€ä¸ªç»„ä»¶ã€‚

TIP: invalid && (touched || dirty)

å½“è¡¨å•æ§ä»¶__æ— æ•ˆ__ä¸”__è¢«è§¦æ‘¸__æˆ–__è¢«ä¿®æ”¹__æ—¶ï¼Œhttps://github.com/molily/angular-form-testing/tree/main/client/src/app/components/control-errors[`ControlErrorsComponent`] ä¼šæ˜¾ç¤ºé”™è¯¯ã€‚

- __touched__è¡¨ç¤ºç”¨æˆ·å·²ç»èšç„¦åˆ°æ§ä»¶ä¸Šï¼Œä½†åˆå¤±å»äº†ç„¦ç‚¹ï¼ˆè§¦å‘äº†``blur``äº‹ä»¶ï¼‰ã€‚
- __dirty__è¡¨ç¤ºç”¨æˆ·å·²ç»ä¿®æ”¹äº†å€¼ã€‚

ä¾‹å¦‚ï¼Œå¯¹äº `name` æ§ä»¶ï¼Œ`input` å…ƒç´ å’Œ``ControlErrorsComponent``ä¹‹é—´çš„äº¤äº’å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,html]
----
<label>
  Full name
  <input
    type="text"
    formControlName="name"
    aria-required="true"
    appErrorMessage="name-errors"
  />
</label>
<!-- â€¦ -->
<app-control-errors controlName="name" id="name-errors">
  <ng-template let-errors>
    <ng-container *ngIf="errors.required">
      Name must be given.
    </ng-container>
  </ng-template>
</app-control-errors>
----

TIP: ARIA å±æ€§

`appErrorMessage` å±æ€§ä¼šæ¿€æ´» https://github.com/molily/angular-form-testing/blob/main/client/src/app/directives/error-message.directive.ts[`ErrorMessageDirective`]ã€‚å½“è¡¨å•æ§ä»¶æ— æ•ˆä¸”è¢«è§¦æ‘¸æˆ–è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥æŒ‡ä»¤ä¼šæ·»åŠ ``aria-invalid``å’Œ``aria-errormessage``å±æ€§ã€‚

``aria-invalid``å°†æ§ä»¶æ ‡è®°ä¸ºè¾…åŠ©æŠ€æœ¯ï¼ˆå¦‚å±å¹•é˜…è¯»å™¨ï¼‰ä¸­çš„æ— æ•ˆæ§ä»¶ã€‚``aria-errormessage``æŒ‡å‘åŒ…å«é”™è¯¯æ¶ˆæ¯çš„å¦ä¸€ä¸ªå…ƒç´ ã€‚

TIP: å°†æ§ä»¶ä¸é”™è¯¯ä¿¡æ¯å…³è”èµ·æ¥

åœ¨å‡ºç°é”™è¯¯æ—¶ï¼Œè¯¥æŒ‡ä»¤å°†``aria-errormessage``è®¾ç½®ä¸ºç›¸åº”çš„``app-control-errors``å…ƒç´ çš„idã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¯¥idä¸º``name-errors``ã€‚è¿™æ ·ï¼Œå±å¹•é˜…è¯»å™¨ç”¨æˆ·å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å…³è”çš„é”™è¯¯æ¶ˆæ¯ã€‚

æ§ä»¶ç‰¹å®šçš„é”™è¯¯æ¶ˆæ¯ä»ç„¶ä½äº``signup-form.component.html``ä¸­ã€‚å®ƒä»¬ä½œä¸º``ng-template``ä¼ é€’ç»™``ControlErrorsComponent``ã€‚``ControlErrorsComponent``åŠ¨æ€åœ°æ¸²æŸ“æ¨¡æ¿ï¼Œå¹¶å°†``errors``å¯¹è±¡ä½œä¸ºå˜é‡ä¼ é€’è¿›å»ï¼š

[source,html]
----
<ng-template let-errors>
  <ng-container *ngIf="errors.required">
    Name must be given.
  </ng-container>
</ng-template>
----

æ‚¨ä¸éœ€è¦ç†è§£è¿™ä¸ªç‰¹å®šå®ç°çš„ç»†èŠ‚ã€‚åœ¨æ³¨å†Œè¡¨å•ä¸­ï¼Œè§£å†³æ–¹æ¡ˆåªæ˜¯æ˜¾ç¤ºé”™è¯¯ã€é¿å…é‡å¤å¹¶ä¸ºå¯è®¿é—®æ€§è®¾ç½®ARIAå±æ€§çš„å¯èƒ½æ€§ä¹‹ä¸€ã€‚

ä»ç”¨æˆ·å’Œæµ‹è¯•çš„è§’åº¦æ¥çœ‹ï¼Œå®ç°é”™è¯¯æ¶ˆæ¯çš„æ¸²æŸ“æ–¹å¼å¹¶ä¸é‡è¦â€”â€”åªè¦å®ƒä»¬å­˜åœ¨å¹¶ä¸”å¯è®¿é—®å³å¯ã€‚

TIP: å®ç°ç»†èŠ‚

æˆ‘ä»¬å°†åœ¨**é»‘ç›’é›†æˆæµ‹è¯•**ä¸­æµ‹è¯•``SignupFormComponent``ä¸``ControlErrorsComponent``å’Œ``ErrorMessageDirective``çš„é…åˆä½¿ç”¨ã€‚å¯¹äºè¿™ä¸ªæµ‹è¯•ï¼Œåä¸¤è€…å°†æ˜¯æ— å…³ç´§è¦çš„å®ç°ç»†èŠ‚ã€‚

[NOTE]
====
- https://angular.cn/guide/form-validation[AngularæŒ‡å—ï¼šéªŒè¯è¡¨å•è¾“å…¥]
- https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA[MDNï¼šARIAç®€ä»‹]
- https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Attributes/aria-invalid[MDNï¼šaria-invalid]
- https://www.w3.org/TR/wai-aria-1.1/#aria-errormessage[ARIAè§„èŒƒï¼šaria-errormessage]
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/directives/error-message.directive.ts[ErrorMessageDirectiveï¼šå®Œæ•´ä»£ç ]
- https://github.com/molily/angular-form-testing/tree/main/client/src/app/components/control-errors[ControlErrorsComponentï¼šå®Œæ•´ä»£ç ]
====

== æµ‹è¯•è®¡åˆ’

å“ªäº›æ³¨å†Œè¡¨å•çš„é‡è¦éƒ¨åˆ†éœ€è¦è¿›è¡Œæµ‹è¯•ï¼Ÿ

1. è¡¨å•æäº¤
  - xref:_æˆåŠŸæäº¤è¡¨å•[æˆåŠŸæäº¤]
  - xref:_æ— æ•ˆçš„è¡¨å•[ä¸è¦æäº¤æ— æ•ˆçš„è¡¨å•]
  - xref:_è¡¨å•æäº¤å¤±è´¥[æäº¤å¤±è´¥]
2. xref:_å¿…å¡«å­—æ®µ[å¿…å¡«å­—æ®µè¢«æ ‡è®°ä¸ºå¿…å¡«ï¼Œå¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯]
3. xref:_å¼‚æ­¥éªŒè¯å™¨[å¯¹ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç è¿›è¡Œå¼‚æ­¥éªŒè¯]
4. xref:_åŠ¨æ€å­—æ®µå…³ç³»[åŠ¨æ€å­—æ®µå…³ç³»]
5. xref:_å¯†ç ç±»å‹åˆ‡æ¢[å¯†ç ç±»å‹åˆ‡æ¢]
6. xref:_æµ‹è¯•è¡¨å•çš„å¯è®¿é—®æ€§[è¡¨å•ç»“æ„ã€å­—æ®µæ ‡ç­¾å’Œé”™è¯¯æ¶ˆæ¯çš„å¯è®¿é—®æ€§]

== æµ‹è¯•è®¾ç½®

åœ¨ https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[`signup-form.component.spec.ts`]ä¸­ç¼–å†™å„ä¸ªè§„èŒƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®æµ‹è¯•å¥—ä»¶ã€‚è®©æˆ‘ä»¬ä»æµ‹è¯•æ¨¡å—é…ç½®å¼€å§‹ã€‚

[source,typescript]
----
await TestBed.configureTestingModule({
  imports: [ReactiveFormsModule],
  declarations: [
    SignupFormComponent,
    ControlErrorsComponent,
    ErrorMessageDirective
  ],
  providers: [
    { provide: SignupService, useValue: signupService }
  ],
}).compileComponents();
----

è¢«æµ‹è¯•çš„ç»„ä»¶åŒ…å«ä¸€ä¸ªå“åº”å¼è¡¨å•ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯¼å…¥äº†``ReactiveFormsModule``ï¼š

[source,typescript]
----
imports: [ReactiveFormsModule],
----

TIP: æ·±åº¦æ¸²æŸ“

å¦‚æè¿°çš„é‚£æ ·ï¼Œæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªé›†æˆæµ‹è¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬å£°æ˜ç»„ä»¶åŠå…¶å­ç»„ä»¶ï¼š

[source,typescript]
----
declarations: [
  SignupFormComponent,
  ControlErrorsComponent,
  ErrorMessageDirective
],
----

TIP: è™šæ‹ŸæœåŠ¡

``SignupFormComponent``ä¾èµ–äº``SignupService``ã€‚å½“æµ‹è¯•è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å‘åç«¯å‘é€HTTPè¯·æ±‚ï¼Œå› æ­¤æˆ‘ä»¬ <<testing-components-depending-on-services#_è™šæ‹ŸæœåŠ¡ä¾èµ–, å°†è¯¥æœåŠ¡æ›¿æ¢ä¸ºä¸€ä¸ªè™šæ‹Ÿå®ä¾‹>>ã€‚

[source,typescript]
----
providers: [
  { provide: SignupService, useValue: signupService }
],
----

ä¸€ä¸ªå¯èƒ½çš„``SignupService``è™šæ‹Ÿå®ä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,typescript]
----
const signupService:
  Pick<SignupService, keyof SignupService> = {
  isUsernameTaken() {
    return of(false);
  },
  isEmailTaken() {
    return of(false);
  },
  getPasswordStrength() {
    return of(strongPassword);
  },
  signup() {
    return of({ success: true });
  },
};
----

è¿™ä¸ªè™šæ‹Ÿå®ä¾‹å®ç°äº†__æˆåŠŸçš„æƒ…å†µ__ï¼šç”¨æˆ·åå’Œç”µå­é‚®ä»¶å¯ç”¨ï¼Œå¯†ç è¶³å¤Ÿå¼ºå¤§ï¼Œå¹¶ä¸”è¡¨å•æäº¤æˆåŠŸã€‚

ç”±äºæˆ‘ä»¬è¿˜å°†æµ‹è¯•å…¶ä»–é”™è¯¯æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åŠ¨æ€åˆ›å»º``SignupService``çš„è™šæ‹Ÿå®ä¾‹ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨Jasmineçš„spyæ¥éªŒè¯Serviceæ–¹æ³•æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨ã€‚

TIP: `createSpyObj`

è¿™å°±æ˜¯Jasmineçš„``createSpyObj``çš„ç”¨é€”ï¼ˆå‚è§ <<testing-components-depending-on-services#_è™šæ‹ŸæœåŠ¡ä¾èµ–,è™šæ‹ŸæœåŠ¡ä¾èµ–>>ï¼‰ã€‚

[source,typescript]
----
const signupService = jasmine.createSpyObj<SignupService>(
  'SignupService',
  {
    // Successful responses per default
    isUsernameTaken: of(false),
    isEmailTaken: of(false),
    getPasswordStrength: of(strongPassword),
    signup: of({ success: true }),
  }
);
----

TIP: è®¾ç½®å‡½æ•°

ä¸æµ‹è¯•æ¨¡å—é…ç½®ä¸€èµ·ï¼Œæˆ‘ä»¬å°†è¿™æ®µä»£ç æ”¾å…¥ä¸€ä¸ªè®¾ç½®å‡½æ•°ä¸­ã€‚ä¸ºäº†è°ƒæ•´``SignupService``è™šæ‹Ÿå®ä¾‹çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å…è®¸ä¼ é€’æ–¹æ³•çš„è¿”å›å€¼ã€‚

[source,typescript]
----
describe('SignupFormComponent', () => {
  let fixture: ComponentFixture<SignupFormComponent>;
  let signupService: jasmine.SpyObj<SignupService>;

  const setup = async (
    signupServiceReturnValues?:
      jasmine.SpyObjMethodNames<SignupService>,
  ) => {
    signupService = jasmine.createSpyObj<SignupService>(
      'SignupService',
      {
        // Successful responses per default
        isUsernameTaken: of(false),
        isEmailTaken: of(false),
        getPasswordStrength: of(strongPassword),
        signup: of({ success: true }),
        // Overwrite with given return values
        ...signupServiceReturnValues,
      }
    );

    await TestBed.configureTestingModule({
      imports: [ReactiveFormsModule],
      declarations: [
        SignupFormComponent,
        ControlErrorsComponent,
        ErrorMessageDirective
      ],
      providers: [
        { provide: SignupService, useValue: signupService }
      ],
    }).compileComponents();

    fixture = TestBed.createComponent(SignupFormComponent);
    fixture.detectChanges();
  };

  /* â€¦ */
});
----

åœ¨æ‰€æœ‰æ¥ä¸‹æ¥çš„è§„èŒƒä¸­ï¼Œæˆ‘ä»¬å°†é¦–å…ˆè°ƒç”¨ `setup` å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬ç®€å•åœ°ç¼–å†™``async setup()``ï¼Œåˆ™``SignupService``è™šæ‹Ÿå®ä¾‹å°†è¿”å›æˆåŠŸçš„å“åº”ã€‚

æˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªå¸¦æœ‰ä¸åŒè¿”å›å€¼çš„å¯¹è±¡æ¥æ¨¡æ‹Ÿå¤±è´¥ã€‚ä¾‹å¦‚ï¼Œåœ¨æµ‹è¯•ç”¨æˆ·åå·²è¢«ä½¿ç”¨æ—¶ï¼š

[source,typescript]
----
await setup({
  // Let the API return that the username is taken
  isUsernameTaken: of(true),
});
----

è¿™æ ·çš„ `setup` å‡½æ•°åªæ˜¯åˆ›å»ºä¼ªé€ æ•°æ®å¹¶é¿å…é‡å¤çš„ä¸€ç§æ–¹å¼ã€‚æ‚¨å¯ä»¥æå‡ºå…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œä»¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponentï¼šæµ‹è¯•ä»£ç ]
====

== æˆåŠŸæäº¤è¡¨å•

æˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ç¬¬ä¸€ä¸ªæƒ…å†µæ˜¯æˆåŠŸæäº¤è¡¨å•ã€‚å¦‚æœç”¨æˆ·å¡«å†™äº†æ‰€æœ‰å¿…å¡«å­—æ®µå¹¶ä¸”éªŒè¯é€šè¿‡ï¼Œæˆ‘ä»¬æœŸæœ›è¯¥ç»„ä»¶è°ƒç”¨``SignupService``çš„``signup``æ–¹æ³•ï¼Œå¹¶å°†è¾“å…¥çš„è¡¨å•æ•°æ®ä½œä¸ºå‚æ•°ã€‚

TIP: æµ‹è¯•æ•°æ®

ç¬¬ä¸€æ­¥æ˜¯å®šä¹‰__æœ‰æ•ˆçš„æµ‹è¯•æ•°æ®__ï¼Œæˆ‘ä»¬å¯ä»¥å¡«å……åˆ°è¡¨å•ä¸­ã€‚æˆ‘ä»¬å°†å…¶æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œhttps://github.com/molily/angular-form-testing/blob/main/client/src/app/spec-helpers/signup-data.spec-helper.ts[signup-data.spec-helper.ts]ï¼š

[source,typescript]
----
export const username = 'quickBrownFox';
export const password = 'dog lazy the over jumps fox brown quick the';
export const email = 'quick.brown.fox@example.org';
export const name = 'Mr. Fox';
export const addressLine1 = '';
export const addressLine2 = 'Under the Tree 1';
export const city = 'Farmtown';
export const postcode = '123456';
export const region = 'Upper South';
export const country = 'Luggnagg';

export const signupData: SignupData = {
  plan: 'personal',
  username,
  email,
  password,
  address: {
    name, addressLine1, addressLine2,
    city, postcode, region, country
  },
  tos: true,
};
----

åœ¨ https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.html[signup-form.component.html]æ¨¡æ¿ä¸­ï¼Œæ‰€æœ‰çš„å­—æ®µå…ƒç´ éƒ½éœ€è¦ç”¨æµ‹è¯•IDæ ‡è®°ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¨‹åºæ‰¾åˆ°å®ƒä»¬å¹¶è¾“å…¥å€¼ã€‚

ä¾‹å¦‚ï¼Œç”¨æˆ·åè¾“å…¥æ¡†ä½¿ç”¨æµ‹è¯•ID `username`ï¼Œç”µå­é‚®ä»¶è¾“å…¥æ¡†ä½¿ç”¨ `email`ï¼Œä¾æ­¤ç±»æ¨ã€‚

å›åˆ°``signup-form.component.spec.ts``ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„è§„èŒƒ(spec)ï¼Œå¹¶è°ƒç”¨è®¾ç½®å‡½æ•°(setup function)ã€‚

[source,typescript]
----
it('submits the form successfully', async () => {
    await setup();

    /* â€¦ */
});
----

TIP: å¡«å†™è¡¨å•

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨æœ‰æ•ˆçš„å€¼å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µã€‚ç”±äºæˆ‘ä»¬éœ€è¦åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªè§„èŒƒ(spec)ä¸­éƒ½è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯é‡å¤ä½¿ç”¨çš„å‡½æ•°ã€‚

[source,typescript]
----
const fillForm = () => {
  setFieldValue(fixture, 'username', username);
  setFieldValue(fixture, 'email', email);
  setFieldValue(fixture, 'password', password);
  setFieldValue(fixture, 'name', name);
  setFieldValue(fixture, 'addressLine1', addressLine1);
  setFieldValue(fixture, 'addressLine2', addressLine2);
  setFieldValue(fixture, 'city', city);
  setFieldValue(fixture, 'postcode', postcode);
  setFieldValue(fixture, 'region', region);
  setFieldValue(fixture, 'country', country);
  checkField(fixture, 'tos', true);
};
----

``fillForm``å‡½æ•°ä½äº``describe``çš„ä½œç”¨åŸŸå†…ï¼Œå› æ­¤å®ƒå¯ä»¥è®¿é—®``fixture``å˜é‡ã€‚å®ƒä½¿ç”¨``setFieldValue``å’Œ``checkField`` <<testing-components#_æµ‹è¯•è¾…åŠ©å‡½æ•°, å…ƒç´ æµ‹è¯•åŠ©æ‰‹>>ã€‚

åœ¨è§„èŒƒ(spec)ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨``fillForm``å‡½æ•°ï¼š

[source,typescript]
----
it('submits the form successfully', async () => {
    await setup();

    fillForm();

    /* â€¦ */
});
----

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å°è¯•ç«‹å³æäº¤è¡¨å•ã€‚è¢«æµ‹è¯•çš„è¡¨å•åœ¨``form``å…ƒç´ ä¸Šç›‘å¬ https://angular.cn/api/forms/NgForm#listening-for-form-submission[``ngSubmit``äº‹ä»¶]ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸç”Ÿçš„``submit``äº‹ä»¶ã€‚

TIP: æäº¤è¡¨å•

æˆ‘ä»¬é€šè¿‡å…¶æµ‹è¯•IDæ‰¾åˆ° `form` å…ƒç´ ï¼Œå¹¶æ¨¡æ‹Ÿä¸€ä¸ª``submit``äº‹ä»¶ï¼ˆå‚è§ <<testing-components#_è§¦å‘äº‹ä»¶å¤„ç†ç¨‹åº,è§¦å‘äº‹ä»¶å¤„ç†ç¨‹åº>>ï¼‰ã€‚

ç„¶åï¼Œæˆ‘ä»¬æœŸæœ›``signup`` spyå·²ç»è¢«è°ƒç”¨ï¼Œå¹¶ä½¿ç”¨è¾“å…¥çš„æ•°æ®ä½œä¸ºå‚æ•°ã€‚

[source,typescript]
----
it('submits the form successfully', async () => {
    await setup();

    fillForm();

    findEl(fixture, 'form').triggerEventHandler('submit', {});

    expect(signupService.signup).toHaveBeenCalledWith(signupData);
});
----

å¦‚æœæˆ‘ä»¬è¿è¡Œè¿™ä¸ªè§„èŒƒ(spec)ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒå¤±è´¥äº†ï¼š

[source,]
----
Expected spy SignupService.signup to have been called with:
  [ Object({ plan: 'personal', â€¦ }) ]
but it was never called.
----

è§„èŒƒ(spec)å¤±è´¥æ˜¯å› ä¸ºå°½ç®¡æˆ‘ä»¬æ­£ç¡®å¡«å†™äº†æ‰€æœ‰å­—æ®µï¼Œä½†è¡¨å•ä»å¤„äº__æ— æ•ˆ__çŠ¶æ€ã€‚

TIP: å¼‚æ­¥éªŒè¯å™¨

é€ æˆé—®é¢˜çš„æ˜¯ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç çš„**å¼‚æ­¥éªŒè¯å™¨**ã€‚å½“ç”¨æˆ·åœæ­¢åœ¨è¿™äº›å­—æ®µä¸­è¾“å…¥æ—¶ï¼Œå®ƒä»¬ä¼šç­‰å¾…ä¸€ç§’é’Ÿï¼Œç„¶åå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚

åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒHTTPè¯·æ±‚éœ€è¦é¢å¤–çš„æ—¶é—´ï¼Œä½†æˆ‘ä»¬çš„ä¼ªé€ ``SignupService``ç«‹å³è¿”å›å“åº”ã€‚

TIP: ä¸€ç§’çš„é˜²æŠ–

è¿™ç§å‡å°‘è¯·æ±‚é‡çš„æŠ€æœ¯ç§°ä¸º__é˜²æŠ–(debouncing)__ã€‚ä¾‹å¦‚ï¼Œè¾“å…¥ç”¨æˆ·å"fox"åº”è¯¥å‘é€__ä¸€ä¸ª__å¸¦æœ‰"fox"çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯è¿ç»­å‘é€__ä¸‰ä¸ª__å¸¦æœ‰"f"ã€"fo"ã€"fox"çš„è¯·æ±‚ã€‚

ä¸Šè¿°è§„èŒƒåœ¨å¡«å†™å­—æ®µåç«‹å³æäº¤è¡¨å•ã€‚åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œå¼‚æ­¥éªŒè¯å™¨å·²ç»è¢«è°ƒç”¨ï¼Œä½†å°šæœªè¿”å›å€¼ã€‚å®ƒä»¬ä»åœ¨ç­‰å¾…é˜²æŠ–æœŸè¿‡å»ã€‚

å› æ­¤ï¼Œæµ‹è¯•éœ€è¦ç­‰å¾…ä¸€ç§’é’Ÿä»¥ç­‰å¾…å¼‚æ­¥éªŒè¯å™¨ã€‚ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªä½¿ç”¨ `setTimeout(() => { /* â€¦ */}, 1000)` çš„å¼‚æ­¥æµ‹è¯•ã€‚ä½†è¿™ä¼šå‡æ…¢æˆ‘ä»¬çš„è§„èŒƒ(spec)çš„æ‰§è¡Œé€Ÿåº¦ã€‚

TIP: `fakeAsync` å’Œ `tick`

ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Angularçš„``fakeAsync``å’Œ``tick``å‡½æ•°æ¥__æ¨¡æ‹Ÿ__æ—¶é—´çš„æµé€ã€‚å®ƒä»¬æ˜¯æµ‹è¯•å¼‚æ­¥è¡Œä¸ºçš„å¼ºå¤§ç»„åˆã€‚

``fakeAsync``å†»ç»“æ—¶é—´ã€‚å®ƒä¼šé’©å…¥ç”±å®šæ—¶å™¨ã€é—´éš”ã€Promiseså’ŒObservablesåˆ›å»ºçš„å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†è¿‡ç¨‹ã€‚å®ƒé˜²æ­¢è¿™äº›ä»»åŠ¡è¢«æ‰§è¡Œã€‚

TIP: æ¨¡æ‹Ÿæ—¶é—´çš„æµé€

åœ¨``fakeAsync``åˆ›å»ºçš„æ—¶é—´æ‰­æ›²ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨``tick``å‡½æ•°æ¥æ¨¡æ‹Ÿæ—¶é—´çš„æµé€ã€‚è®¡åˆ’çš„ä»»åŠ¡å°†è¢«æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•å®ƒä»¬çš„æ•ˆæœã€‚

``fakeAsync``å’Œ``tick``çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºæ—¶é—´çš„æµé€åªæ˜¯è™šæ‹Ÿçš„ã€‚å³ä½¿åœ¨æ¨¡æ‹Ÿä¸­ç»è¿‡ä¸€ç§’é’Ÿï¼Œè§„èŒƒä»ç„¶åœ¨å‡ æ¯«ç§’å†…å®Œæˆã€‚

``fakeAsync``åŒ…è£…äº†è§„èŒƒå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”±äº `setup` è°ƒç”¨è€Œä¹Ÿæ˜¯ä¸€ä¸ª``å¼‚æ­¥``å‡½æ•°ã€‚åœ¨å¡«å†™è¡¨å•åï¼Œæˆ‘ä»¬ä½¿ç”¨ `tick(1000)` æ¥æ¨¡æ‹Ÿç­‰å¾…çš„æ—¶é—´ã€‚

[source,typescript]
----
it('submits the form successfully', fakeAsync(async () => {
  await setup();

  fillForm();

  // Wait for async validators
  tick(1000);

  findEl(fixture, 'form').triggerEventHandler('submit', {});

  expect(signupService.signup).toHaveBeenCalledWith(signupData);
}));
----

è¿™ä¸ªè§„èŒƒ(spec)é€šè¿‡äº†ï¼ç°åœ¨æˆ‘ä»¬åº”è¯¥æ·»åŠ ä¸€äº›æœŸæœ›æ¥æµ‹è¯•ç»†èŠ‚ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æœŸæœ›å¼‚æ­¥éªŒè¯å™¨è°ƒç”¨``SignupService``çš„æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨ç”¨æˆ·è¾“å…¥ä½œä¸ºå‚æ•°ã€‚è¿™äº›æ–¹æ³•æ˜¯``isUsernameTaken``ã€``isEmailTaken``å’Œ``getPasswordStrength``ã€‚

[source,typescript]
----
it('submits the form successfully', fakeAsync(async () => {
  await setup();

  fillForm();

  // Wait for async validators
  tick(1000);

  findEl(fixture, 'form').triggerEventHandler('submit', {});

  expect(signupService.isUsernameTaken).toHaveBeenCalledWith(username);
  expect(signupService.isEmailTaken).toHaveBeenCalledWith(email);
  expect(signupService.getPasswordStrength).toHaveBeenCalledWith(password);
  expect(signupService.signup).toHaveBeenCalledWith(signupData);
}));
----

TIP: æäº¤æŒ‰é’®

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦ç¡®ä¿æäº¤æŒ‰é’®æœ€åˆå¤„äºç¦ç”¨çŠ¶æ€ã€‚åœ¨æˆåŠŸéªŒè¯åï¼ŒæŒ‰é’®å°†å¯ç”¨ã€‚ï¼ˆæäº¤æŒ‰é’®ä½¿ç”¨æµ‹è¯•ID `submit`ã€‚ï¼‰

TIP: çŠ¶æ€æ¶ˆæ¯

æ­¤å¤–ï¼Œå½“è¡¨å•æˆåŠŸæäº¤æ—¶ï¼Œéœ€è¦å‡ºç°çŠ¶æ€æ¶ˆæ¯"Sign-up successful!"ã€‚ï¼ˆçŠ¶æ€æ¶ˆæ¯ä½¿ç”¨æµ‹è¯•ID `status`ã€‚ï¼‰

è¿™å°†å¸¦æˆ‘ä»¬è¿›å…¥æœ€ç»ˆçš„è§„èŒƒ(spec)ï¼š

[source,typescript]
----
it('submits the form successfully', fakeAsync(async () => {
  await setup();

  fillForm();
  fixture.detectChanges();

  expect(findEl(fixture, 'submit').properties.disabled).toBe(true);

  // Wait for async validators
  tick(1000);
  fixture.detectChanges();

  expect(findEl(fixture, 'submit').properties.disabled).toBe(false);

  findEl(fixture, 'form').triggerEventHandler('submit', {});
  fixture.detectChanges();

  expectText(fixture, 'status', 'Sign-up successful!');

  expect(signupService.isUsernameTaken).toHaveBeenCalledWith(username);
  expect(signupService.isEmailTaken).toHaveBeenCalledWith(email);
  expect(signupService.getPasswordStrength).toHaveBeenCalledWith(password);
  expect(signupService.signup).toHaveBeenCalledWith(signupData);
}));
----

å› ä¸ºæˆ‘ä»¬æ­£åœ¨æµ‹è¯•DOMçš„å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨æ¯ä¸ª _Act_ é˜¶æ®µä¹‹åè°ƒç”¨``detectChanges``ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.tsSignupFormComponentï¼šæµ‹è¯•ä»£ç ]
- https://angular.cn/api/core/testing/fakeAsyncAngular APIå‚è€ƒï¼šfakeAsync]
- https://angular.cn/api/core/testing/tickAngular APIå‚è€ƒï¼štick]
====

== æ— æ•ˆçš„è¡¨å•

ç°åœ¨æˆ‘ä»¬å·²ç»æµ‹è¯•äº†æˆåŠŸæäº¤è¡¨å•çš„æƒ…å†µï¼Œè®©æˆ‘ä»¬æ¥æ£€æŸ¥æ— æ•ˆè¡¨å•çš„å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰å¡«å†™ä»»ä½•å­—æ®µï¼Œä½†æäº¤è¡¨å•ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬ä¸ºè¿™ç§æƒ…å†µåˆ›å»ºä¸€ä¸ªæ–°çš„è§„èŒƒ(spec)ï¼š

[source,typescript]
----
it('does not submit an invalid form', fakeAsync(async () => {
  await setup();

  // Wait for async validators
  tick(1000);

  findEl(fixture, 'form').triggerEventHandler('submit', {});

  expect(signupService.isUsernameTaken).not.toHaveBeenCalled();
  expect(signupService.isEmailTaken).not.toHaveBeenCalled();
  expect(signupService.getPasswordStrength).not.toHaveBeenCalled();
  expect(signupService.signup).not.toHaveBeenCalled();
}));
----

è¿™ä¸ªè§„èŒƒ(spec)æ¯”ä¹‹å‰çš„è§„èŒƒè¦ç®€å•ã€‚æˆ‘ä»¬ç­‰å¾…ä¸€ç§’é’Ÿï¼Œç„¶ååœ¨ä¸è¾“å…¥æ•°æ®çš„æƒ…å†µä¸‹æäº¤è¡¨å•ã€‚æœ€åï¼Œæˆ‘ä»¬æœŸæœ›æ²¡æœ‰è°ƒç”¨ä»»ä½•``SignupService``æ–¹æ³•ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponentï¼šæµ‹è¯•ä»£ç ]
====

== è¡¨å•æäº¤å¤±è´¥

æˆ‘ä»¬å·²ç»æµ‹è¯•äº†æˆåŠŸæäº¤è¡¨å•çš„æƒ…å†µã€‚ç°åœ¨è®©æˆ‘ä»¬æµ‹è¯•è¡¨å•æäº¤å¤±è´¥çš„æƒ…å†µã€‚

TIP: å¤±è´¥åŸå› 

å°½ç®¡è¾“å…¥æ­£ç¡®ï¼Œæäº¤å¯èƒ½å› ä¸ºä»¥ä¸‹å‡ ä¸ªåŸå› è€Œå¤±è´¥ï¼š

- ç½‘ç»œä¸å¯ç”¨
- åç«¯å¤„ç†äº†è¯·æ±‚ï¼Œä½†è¿”å›äº†é”™è¯¯ï¼š
  - æœåŠ¡å™¨ç«¯éªŒè¯å¤±è´¥
  - è¯·æ±‚çš„ç»“æ„ä¸é¢„æœŸä¸ç¬¦
  - æœåŠ¡å™¨ä»£ç æœ‰é”™è¯¯ã€å´©æºƒæˆ–å†»ç»“

TIP: Observable

å½“ç”¨æˆ·æäº¤è¡¨å•æ—¶ï¼Œè¢«æµ‹è¯•çš„ç»„ä»¶è°ƒç”¨``SignupService``çš„``signup``æ–¹æ³•ã€‚

- åœ¨__æˆåŠŸæƒ…å†µ__ä¸‹ï¼Œ``signup``æ–¹æ³•è¿”å›ä¸€ä¸ªå‘å‡ºå€¼ä¸º `{ success: true }` çš„Observableï¼Œå¹¶å®Œæˆã€‚è¡¨å•æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯"Sign-up successful!"ã€‚
- åœ¨__é”™è¯¯æƒ…å†µä¸‹__ï¼ŒObservableä¼šå¤±è´¥å¹¶æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚è¡¨å•æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯"Sign-up error"ã€‚

è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–°çš„è§„èŒƒ(spec)ä¸­æµ‹è¯•åä¸€ç§æƒ…å†µã€‚å…¶ç»“æ„ç±»ä¼¼äºæˆåŠŸæäº¤çš„è§„èŒƒã€‚ä½†æˆ‘ä»¬é…ç½®ä¼ªé€ çš„``signup``æ–¹æ³•è¿”å›ä¸€ä¸ªå¤±è´¥çš„Observableã€‚

[source,typescript]
----
import { throwError } from 'rxjs';
----

[source,typescript]
----
it('handles signup failure', fakeAsync(async () => {
  await setup({
    // Let the API report a failure
    signup: throwError(new Error('Validation failed')),
  });

  /* â€¦Â */
});
----

æˆ‘ä»¬å¡«å†™è¡¨å•ï¼Œç­‰å¾…éªŒè¯å™¨å®Œæˆï¼Œç„¶åæäº¤è¡¨å•ã€‚

[source,typescript]
----
fillForm();

// Wait for async validators
tick(1000);

findEl(fixture, 'form').triggerEventHandler('submit', {});
fixture.detectChanges();
----

TIP: çŠ¶æ€æ¶ˆæ¯

æœ€åï¼Œæˆ‘ä»¬æœŸæœ›å‡ºç°"Sign-up error"çš„çŠ¶æ€æ¶ˆæ¯ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éªŒè¯ç›¸å…³çš„``SignupService``æ–¹æ³•æ˜¯å¦å·²è¢«è°ƒç”¨ã€‚

[source,typescript]
----
expectText(fixture, 'status', 'Sign-up error');

expect(signupService.isUsernameTaken).toHaveBeenCalledWith(username);
expect(signupService.getPasswordStrength).toHaveBeenCalledWith(password);
expect(signupService.signup).toHaveBeenCalledWith(signupData);
----

å®Œæ•´çš„è§„èŒƒ(spec)å¦‚ä¸‹ï¼š

[source,typescript]
----
it('handles signup failure', fakeAsync(async () => {
  await setup({
    // Let the API report a failure
    signup: throwError(new Error('Validation failed')),
  });

  fillForm();

  // Wait for async validators
  tick(1000);

  findEl(fixture, 'form').triggerEventHandler('submit', {});
  fixture.detectChanges();

  expectText(fixture, 'status', 'Sign-up error');

  expect(signupService.isUsernameTaken).toHaveBeenCalledWith(username);
  expect(signupService.getPasswordStrength).toHaveBeenCalledWith(password);
  expect(signupService.signup).toHaveBeenCalledWith(signupData);
}));
----

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponent: æµ‹è¯•ä»£ç ]
====

== å¿…å¡«å­—æ®µ

ä¸€ä¸ªå…³é”®çš„è¡¨å•é€»è¾‘æ˜¯æŸäº›å­—æ®µæ˜¯å¿…å¡«çš„ï¼Œå¹¶ä¸”ç”¨æˆ·ç•Œé¢æ¸…æ¥šåœ°ä¼ è¾¾äº†è¿™ä¸ªäº‹å®ã€‚è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè§„èŒƒ(spec)æ¥æ£€æŸ¥æ˜¯å¦å°†å¿…å¡«å­—æ®µæ ‡è®°ä¸ºå¿…å¡«ã€‚

TIP: è¦æ±‚

è¦æ±‚å¦‚ä¸‹ï¼š

- å¿…å¡«å­—æ®µå…·æœ‰``aria-required``å±æ€§ã€‚
- å¿…å¡«ä½†æ— æ•ˆçš„å­—æ®µå…·æœ‰``aria-errormessage``å±æ€§ã€‚å®ƒåŒ…å«å¦ä¸€ä¸ªå…ƒç´ çš„idã€‚
- è¯¥å…ƒç´ åŒ…å«é”™è¯¯æ¶ˆæ¯ â€œâ€¦ must be givenâ€ï¼ˆâ€œTerms of Servicesâ€å¤é€‰æ¡†çš„æ–‡æœ¬ä¸ºâ€œPlease accept the Terms and Servicesâ€ï¼‰ã€‚

æˆ‘ä»¬çš„è§„èŒƒ(spec)éœ€è¦éªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œå› æ­¤æˆ‘ä»¬ç¼–åˆ¶äº†ä¸€ä¸ªå®ƒä»¬å„è‡ªçš„æµ‹è¯•IDåˆ—è¡¨ï¼š

[source,typescript]
----
const requiredFields = [
  'username',
  'email',
  'name',
  'addressLine2',
  'city',
  'postcode',
  'country',
  'tos',
];
----

TIP: invalid && (touched || dirty)

åœ¨æ£€æŸ¥å­—æ®µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è§¦å‘è¡¨å•é”™è¯¯çš„æ˜¾ç¤ºã€‚å¦‚ xref:_è¡¨å•éªŒè¯å’Œé”™è¯¯[è¡¨å•éªŒè¯å’Œé”™è¯¯] ä¸­æ‰€è¿°ï¼Œå½“å­—æ®µæ— æ•ˆä¸”__å·²è§¦æ‘¸(touched)__æˆ–__å·²ä¿®æ”¹(dirty)__æ—¶ï¼Œé”™è¯¯æ¶ˆæ¯ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚

å¹¸è¿çš„æ˜¯ï¼Œç©ºçš„ä½†æ˜¯å¿…å¡«çš„å­—æ®µå·²ç»æ˜¯æ— æ•ˆçš„ã€‚è¾“å…¥æ–‡æœ¬ä¼šä½¿å®ƒä»¬å˜ä¸º__dirty__ï¼Œä½†ä¹Ÿæ˜¯__æœ‰æ•ˆ__çš„ã€‚

TIP: æ ‡è®°ä¸ºå·²è§¦æ‘¸(touched)

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦__è§¦æ‘¸(touch)__è¿™äº›å­—æ®µã€‚å¦‚æœä¸€ä¸ªå­—æ®µè¢«èšç„¦å¹¶å†æ¬¡å¤±å»ç„¦ç‚¹ï¼ŒAngularå°†è®¤ä¸ºå®ƒå·²__è¢«è§¦æ‘¸(touched)__ã€‚åœ¨å¹•åï¼ŒAngularä¼šç›‘å¬__blur__äº‹ä»¶ã€‚

åœ¨æˆ‘ä»¬çš„è§„èŒƒ(spec)ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨``dispatchFakeEvent``æµ‹è¯•åŠ©æ‰‹æ¥æ¨¡æ‹Ÿ``blur``äº‹ä»¶ã€‚è®©æˆ‘ä»¬å°†è°ƒç”¨æ”¾åœ¨ä¸€ä¸ªå¯é‡ç”¨çš„å‡½æ•°ä¸­ï¼š

[source,typescript]
----
const markFieldAsTouched = (element: DebugElement) => {
  dispatchFakeEvent(element.nativeElement, 'blur');
};
----

æˆ‘ä»¬ç°åœ¨å¯ä»¥ç¼–å†™è§„èŒƒ(spec)çš„ _å®‰æ’(Arrange)_ å’Œ __æ‰§è¡Œ(Act)__é˜¶æ®µï¼š

[source,typescript]
----
it('marks fields as required', async () => {
  await setup();

  // Mark required fields as touched
  requiredFields.forEach((testId) => {
    markFieldAsTouched(findEl(fixture, testId));
  });
  fixture.detectChanges();

  /* â€¦ */
});
----

ä¸€ä¸ª``forEach``å¾ªç¯éå†å¿…å¡«å­—æ®µçš„æµ‹è¯•IDï¼Œæ‰¾åˆ°ç›¸åº”çš„å…ƒç´ å¹¶å°†å­—æ®µæ ‡è®°ä¸ºå·²è§¦æ‘¸ã€‚ç„¶åæˆ‘ä»¬è°ƒç”¨``detectChanges``ï¼Œä»¥ä¾¿é”™è¯¯æ¶ˆæ¯å‡ºç°ã€‚

TIP: `aria-required`

æ¥ä¸‹æ¥æ˜¯ _æ–­è¨€(Assert)_ é˜¶æ®µã€‚å†æ¬¡éå†å¿…å¡«å­—æ®µï¼Œé€ä¸ªæ£€æŸ¥å®ƒä»¬ã€‚è®©æˆ‘ä»¬ä»``aria-required``å±æ€§å¼€å§‹ã€‚

[source,typescript]
----
requiredFields.forEach((testId) => {
  const el = findEl(fixture, testId);

  // Check aria-required attribute
  expect(el.attributes['aria-required']).toBe(
    'true',
    `${testId} must be marked as aria-required`,
  );

  /* â€¦ */
});
----

``findEl``å‡½æ•°è¿”å›ä¸€ä¸ªå…·æœ‰``attributes``å±æ€§çš„``DebugElement``ã€‚è¯¥å±æ€§åŒ…å«æ¨¡æ¿è®¾ç½®çš„æ‰€æœ‰å±æ€§ã€‚æˆ‘ä»¬æœŸæœ› `aria-required="true"` å±æ€§å­˜åœ¨ã€‚

TIP: `aria-errormessage`

ä¸‹ä¸€éƒ¨åˆ†æµ‹è¯•é”™è¯¯æ¶ˆæ¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

1. è¯»å–``aria-errormessage``å±æ€§ã€‚æœŸæœ›å®ƒè¢«è®¾ç½®ã€‚
2. æ‰¾åˆ°``aria-errormessage``å¼•ç”¨çš„å…ƒç´ ã€‚æœŸæœ›å®ƒå­˜åœ¨ã€‚
3. è¯»å–æ–‡æœ¬å†…å®¹ã€‚æœŸæœ›å¾—åˆ°ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚

æ­¥éª¤1å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,typescript]
----
// Check aria-errormessage attribute
const errormessageId = el.attributes['aria-errormessage'];
if (!errormessageId) {
  throw new Error(`Error message id for ${testId} not present`);
}
----

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Jasmineçš„expectationï¼Œå¦‚ `expect(errormessageId).toBeDefined()`ã€‚ä½†æ˜¯``ï¼ŒerrormessageId``çš„ç±»å‹æ˜¯``string | null``ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `string` ç±»å‹çš„å€¼æ¥è¿›è¡Œåç»­çš„æ“ä½œã€‚

TIP: ç±»å‹æ–­è¨€

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªTypeScriptçš„ç±»å‹æ–­è¨€ï¼Œå°†``null``çš„æƒ…å†µæ’é™¤ï¼Œå¹¶å°†ç±»å‹ç¼©å°ä¸º `string` ç±»å‹ã€‚å¦‚æœè¯¥å±æ€§ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œæˆ‘ä»¬ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™å°†ä½¿æµ‹è¯•å¤±è´¥ï¼Œå¹¶æ˜¾ç¤ºç»™å®šçš„é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿``errormessageId``åœ¨è§„èŒƒ(spec)çš„å…¶ä½™éƒ¨åˆ†æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ã€‚

ç¬¬2æ­¥æ‰¾åˆ°é”™è¯¯æ¶ˆæ¯å…ƒç´ ï¼š

[source,typescript]
----
// Check element with error message
const errormessageEl = document.getElementById(errormessageId);
if (!errormessageEl) {
  throw new Error(`Error message element for ${testId} not found`);
}
----

æˆ‘ä»¬ä½¿ç”¨åŸç”Ÿçš„DOMæ–¹æ³•``document.getElementById``æ¥æ‰¾åˆ°å…ƒç´ ã€‚``errormessageEl``çš„ç±»å‹æ˜¯``HTMLElement | null``ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’é™¤äº†``null``çš„æƒ…å†µï¼Œä»¥ä¾¿ä½¿ç”¨``errormessageEl``ã€‚

TIP: é”™è¯¯æ¶ˆæ¯

æœ€åï¼Œæˆ‘ä»¬ç¡®ä¿è¯¥å…ƒç´ åŒ…å«ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶å¯¹â€œTerms and Servicesâ€æ¶ˆæ¯è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚

[source,typescript]
----
if (errormessageId === 'tos-errors') {
  expect(errormessageEl.textContent).toContain(
    'Please accept the Terms and Services',
  );
} else {
  expect(errormessageEl.textContent).toContain('must be given');
}
----

å®Œæ•´çš„è§„èŒƒ(spec)å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,typescript]
----
it('marks fields as required', async () => {
  await setup();

  // Mark required fields as touched
  requiredFields.forEach((testId) => {
    markFieldAsTouched(findEl(fixture, testId));
  });
  fixture.detectChanges();

  requiredFields.forEach((testId) => {
    const el = findEl(fixture, testId);

    // Check aria-required attribute
    expect(el.attributes['aria-required']).toBe(
      'true',
      `${testId} must be marked as aria-required`,
    );

    // Check aria-errormessage attribute
    const errormessageId = el.attributes['aria-errormessage'];
    if (!errormessageId) {
      throw new Error(
        `Error message id for ${testId} not present`
      );
    }
    // Check element with error message
    const errormessageEl = document.getElementById(errormessageId);
    if (!errormessageEl) {
      throw new Error(
        `Error message element for ${testId} not found`
      );
    }
    if (errormessageId === 'tos-errors') {
      expect(errormessageEl.textContent).toContain(
        'Please accept the Terms and Services',
      );
    } else {
      expect(errormessageEl.textContent).toContain('must be given');
    }
  });
});
----

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponent: æµ‹è¯•ä»£ç ]
====

== å¼‚æ­¥éªŒè¯å™¨

æ³¨å†Œè¡¨å•ä¸­çš„ç”¨æˆ·åã€ç”µå­é‚®ä»¶å’Œå¯†ç éƒ½æœ‰å¼‚æ­¥éªŒè¯å™¨ã€‚å®ƒä»¬æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºå®ƒä»¬ç­‰å¾…ä¸€ç§’é’Ÿå¹¶è¿›è¡ŒHTTPè¯·æ±‚ã€‚åœ¨åº•å±‚ï¼Œå®ƒä»¬ä½¿ç”¨RxJS Observablesæ¥å®ç°ã€‚

TIP: å¼‚æ­¥éªŒè¯å¤±è´¥

æˆ‘ä»¬å·²ç»è¦†ç›–äº†â€œæ­£å¸¸è·¯å¾„â€ï¼Œå…¶ä¸­è¾“å…¥çš„ç”¨æˆ·åå’Œç”µå­é‚®ä»¶éƒ½å¯ç”¨ï¼Œå¯†ç ä¹Ÿè¶³å¤Ÿå¼ºå¤§ã€‚æˆ‘ä»¬éœ€è¦ä¸ºé”™è¯¯æƒ…å†µç¼–å†™ä¸‰ä¸ªè§„èŒƒ(spec)ï¼šç”¨æˆ·åæˆ–ç”µå­é‚®ä»¶å·²è¢«ä½¿ç”¨ï¼Œä»¥åŠå¯†ç å¤ªå¼±ã€‚

è¿™äº›éªŒè¯å™¨è°ƒç”¨äº†``SignupService``çš„æ–¹æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ``SignupService``çš„fakeè¿”å›æˆåŠŸçš„å“åº”ã€‚

[source,typescript]
----
const setup = async (
  signupServiceReturnValues?:
    jasmine.SpyObjMethodNames<SignupService>,
) => {
  signupService = jasmine.createSpyObj<SignupService>(
    'SignupService',
    {
      // Successful responses per default
      isUsernameTaken: of(false),
      isEmailTaken: of(false),
      getPasswordStrength: of(strongPassword),
      signup: of({ success: true }),
      // Overwrite with given return values
      ...signupServiceReturnValues,
    }
  );

  /* â€¦ */
};
----

``setup``å‡½æ•°å…è®¸æˆ‘ä»¬è¦†ç›–è™šæ‹Ÿè¡Œä¸ºã€‚å®ƒæ¥å—ä¸€ä¸ªåŒ…å«``SignupService``æ–¹æ³•è¿”å›å€¼çš„å¯¹è±¡ã€‚

æˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªè§„èŒƒ(spec)ï¼Œä»¥ç›¸åº”åœ°é…ç½®è™šæ‹Ÿè¡Œä¸ºï¼š

[source,typescript]
----
it('fails if the username is taken', fakeAsync(async () => {
  await setup({
    // Let the API return that the username is taken
    isUsernameTaken: of(true),
  });
  /* â€¦ */
}));
----

[source,typescript]
----
it('fails if the email is taken', fakeAsync(async () => {
  await setup({
    // Let the API return that the email is taken
    isEmailTaken: of(true),
  });
  /* â€¦ */
}));
----

[source,typescript]
----
it('fails if the password is too weak', fakeAsync(async () => {
  await setup({
    // Let the API return that the password is weak
    getPasswordStrength: of(weakPassword),
  });
  /* â€¦ */
}));
----

å…¶ä½™çš„éƒ¨åˆ†å¯¹äºæ‰€æœ‰ä¸‰ä¸ªè§„èŒƒ(spec)éƒ½æ˜¯ç›¸åŒçš„ã€‚ä¸‹é¢æ˜¯ç¬¬ä¸€ä¸ªè§„èŒƒ(spec)ï¼š

[source,typescript]
----
it('fails if the username is taken', fakeAsync(async () => {
  await setup({
    // Let the API return that the username is taken
    isUsernameTaken: of(true),
  });

  fillForm();

  // Wait for async validators
  tick(1000);
  fixture.detectChanges();

  expect(findEl(fixture, 'submit').properties.disabled).toBe(true);

  findEl(fixture, 'form').triggerEventHandler('submit', {});

  expect(signupService.isUsernameTaken).toHaveBeenCalledWith(username);
  expect(signupService.isEmailTaken).toHaveBeenCalledWith(email);
  expect(signupService.getPasswordStrength).toHaveBeenCalledWith(password);
  expect(signupService.signup).not.toHaveBeenCalled();
}));
----

æˆ‘ä»¬å¡«å†™è¡¨å•ï¼Œç­‰å¾…å¼‚æ­¥éªŒè¯å™¨å¹¶å°è¯•æäº¤è¡¨å•ã€‚

æˆ‘ä»¬æœŸæœ›è¿™ä¸‰ä¸ªå¼‚æ­¥éªŒè¯å™¨è°ƒç”¨ç›¸åº”çš„``SignupService``æ–¹æ³•ã€‚

ç”¨æˆ·åéªŒè¯å¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æœŸæœ›ç»„ä»¶é˜»æ­¢è¡¨å•æäº¤ã€‚``signup``æ–¹æ³•ä¸åº”è¯¥è¢«è°ƒç”¨ã€‚

å¦‚ä¸Šæ‰€è¿°ï¼Œå¦å¤–ä¸¤ä¸ªè§„èŒƒ(spec) `it('fails if the email is taken', /* â€¦ */)` å’Œ `it('fails if the password is too weak', /* â€¦ */)` é™¤äº†è™šæ‹Ÿè®¾ç½®ä¹‹å¤–ï¼Œçœ‹èµ·æ¥æ˜¯ç›¸åŒçš„ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponent: æµ‹è¯•ä»£ç ]
- https://angular.cn/guide/form-validation#creating-asynchronous-validators[Angularæ–‡æ¡£: åˆ›å»ºå¼‚æ­¥éªŒè¯å™¨]
====

== åŠ¨æ€å­—æ®µå…³ç³»

æ³¨å†Œè¡¨å•æœ‰ä¸€ç»„å›ºå®šçš„å­—æ®µã€‚ä½†æ˜¯``addressLine1``å­—æ®µå–å†³äº``plan``å­—æ®µçš„å€¼ï¼š

- å¦‚æœé€‰æ‹©çš„è®¡åˆ’æ˜¯â€œä¸ªäººâ€ï¼Œåˆ™è¯¥å­—æ®µæ˜¯å¯é€‰çš„ï¼Œæ ‡ç­¾æ˜¾ç¤ºä¸ºâ€œåœ°å€è¡Œ1â€ã€‚
- å¦‚æœé€‰æ‹©çš„è®¡åˆ’æ˜¯â€œå•†ä¸šâ€ï¼Œåˆ™è¯¥å­—æ®µæ˜¯å¿…éœ€çš„ï¼Œæ ‡ç­¾æ˜¾ç¤ºä¸ºâ€œå…¬å¸â€ã€‚
- å¦‚æœé€‰æ‹©çš„è®¡åˆ’æ˜¯â€œæ•™è‚²ä¸éè¥åˆ©â€ï¼Œåˆ™è¯¥å­—æ®µæ˜¯å¿…éœ€çš„ï¼Œæ ‡ç­¾æ˜¾ç¤ºä¸ºâ€œç»„ç»‡â€ã€‚

åœ¨ç»„ä»¶ç±»ä¸­çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

[source,typescript]
----
this.plan.valueChanges.subscribe((plan: Plan) => {
  if (plan !== this.PERSONAL) {
    this.addressLine1.setValidators(required);
  } else {
    this.addressLine1.setValidators(null);
  }
  this.addressLine1.updateValueAndValidity();
});
----

æˆ‘ä»¬ç›‘å¬``plan``æ§ä»¶çš„å€¼å˜åŒ–ã€‚æ ¹æ®é€‰æ‹©ï¼Œæˆ‘ä»¬è¦ä¹ˆç»™``addressLine1``æ§ä»¶æ·»åŠ  `å¿…éœ€(required)` éªŒè¯å™¨ï¼Œè¦ä¹ˆç§»é™¤æ‰€æœ‰éªŒè¯å™¨ã€‚

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Angularé‡æ–°éªŒè¯å­—æ®µå€¼ï¼Œç°åœ¨éªŒè¯å™¨å·²ç»æ”¹å˜ã€‚

è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè§„èŒƒ(spec)æ¥ç¡®ä¿å¯¹äºæŸäº›è®¡åˆ’ï¼Œ``addressLine1``æ˜¯å¿…éœ€çš„ã€‚

[source,typescript]
----
it('requires address line 1 for business and non-profit plans', async () => {
  await setup();

  /* â€¦ */
});
----

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥åˆå§‹çŠ¶æ€ï¼šé€‰æ‹©äº†â€œä¸ªäººâ€è®¡åˆ’ï¼Œ``addressLine1``æ˜¯å¯é€‰çš„ã€‚

æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹``addressLine1``å­—æ®µå…ƒç´ çš„å±æ€§æ¥è¿›è¡Œæ£€æŸ¥ï¼š``ng-invalid``ç±»å’Œ``aria-required``å±æ€§å¿…é¡»ä¸å­˜åœ¨ã€‚

[source,typescript]
----
// Initial state (personal plan)
const addressLine1El = findEl(fixture, 'addressLine1');
expect('ng-invalid' in addressLine1El.classes).toBe(false);
expect('aria-required' in addressLine1El.attributes).toBe(false);
----

ä»è¿™ä¸ªåŸºçº¿å‡ºå‘ï¼Œè®©æˆ‘ä»¬å°†è®¡åˆ’ä»â€œä¸ªäººâ€æ›´æ”¹ä¸ºâ€œå•†ä¸šâ€ã€‚æˆ‘ä»¬ä½¿ç”¨``checkField``è§„èŒƒåŠ©æ‰‹æ¥æ¿€æ´»ç›¸åº”çš„å•é€‰æŒ‰é’®ã€‚

[source,typescript]
----
// Change plan to business
checkField(fixture, 'plan-business', true);
fixture.detectChanges();
----

ä¸ºäº†çœ‹åˆ°æ›´æ”¹çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Angularæ›´æ–°DOMã€‚ç„¶åæˆ‘ä»¬æœŸæœ›``ng-invalid``ç±»å’Œ``aria-required``å­˜åœ¨ã€‚

[source,typescript]
----
expect(addressLine1El.attributes['aria-required']).toBe('true');
expect(addressLine1El.classes['ng-invalid']).toBe(true);
----

æˆ‘ä»¬å¯¹â€œæ•™è‚²å’Œéè¥åˆ©â€è®¡åˆ’æ‰§è¡Œç›¸åŒçš„æ£€æŸ¥ã€‚

[source,typescript]
----
// Change plan to non-profit
checkField(fixture, 'plan-non-profit', true);
fixture.detectChanges();

expect(addressLine1El.attributes['aria-required']).toBe('true');
expect(addressLine1El.classes['ng-invalid']).toBe(true);
----

å°±æ˜¯è¿™æ ·ï¼è¿™å°±æ˜¯å®Œæ•´çš„è§„æ ¼è¯´æ˜ï¼š

[source,typescript]
----
it('requires address line 1 for business and non-profit plans', async () => {
  await setup();

  // Initial state (personal plan)
  const addressLine1El = findEl(fixture, 'addressLine1');
  expect('ng-invalid' in addressLine1El.classes).toBe(false);
  expect('aria-required' in addressLine1El.attributes).toBe(false);

  // Change plan to business
  checkField(fixture, 'plan-business', true);
  fixture.detectChanges();

  expect(addressLine1El.attributes['aria-required']).toBe('true');
  expect(addressLine1El.classes['ng-invalid']).toBe(true);

  // Change plan to non-profit
  checkField(fixture, 'plan-non-profit', true);
  fixture.detectChanges();

  expect(addressLine1El.attributes['aria-required']).toBe('true');
  expect(addressLine1El.classes['ng-invalid']).toBe(true);
});
----

å½“æµ‹è¯• xref:_å¿…å¡«å­—æ®µ[å¿…å¡«å­—æ®µ]æ—¶ï¼Œæˆ‘ä»¬å·²ç»æ£€æŸ¥äº†``aria-required``å±æ€§çš„å­˜åœ¨ã€‚ä¸ºäº†ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬åœ¨æ­¤è§„æ ¼ä¸­ä¹Ÿæ£€æŸ¥``aria-required``ã€‚

ä½œä¸ºç¬¬äºŒä¸ªæŒ‡æ ‡ï¼Œæˆ‘ä»¬æ£€æŸ¥``ng-invalid``ç±»çš„å­˜åœ¨ã€‚è¿™ä¸ªç±»æ˜¯Angularè‡ªå·±åœ¨æ— æ•ˆçš„è¡¨å•å­—æ®µä¸Šè®¾ç½®çš„ï¼Œè€Œä¸éœ€è¦æˆ‘ä»¬é€šè¿‡æ¨¡æ¿æ·»åŠ å®ƒã€‚è¯·æ³¨æ„ï¼Œä»…æœ‰è¯¥ç±»çš„å­˜åœ¨å¹¶ä¸æ„å‘³ç€æ— æ•ˆçŠ¶æ€å·²ç»ä»¥è§†è§‰æ–¹å¼ä¼ è¾¾ã€‚

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥é”™è¯¯æ¶ˆæ¯çš„å­˜åœ¨ï¼Œå°±åƒåœ¨å¿…å¡«å­—æ®µè§„æ ¼ä¸­æ‰€åšçš„é‚£æ ·ã€‚

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponentï¼šæµ‹è¯•ä»£ç ]
====

== å¯†ç ç±»å‹åˆ‡æ¢

å¯†ç ç±»å‹åˆ‡æ¢ æ³¨å†Œè¡¨å•çš„å¦ä¸€ä¸ªå°åŠŸèƒ½æ˜¯å¯†ç ç±»å‹åˆ‡æ¢å™¨ã€‚æ­¤æŒ‰é’®åˆ‡æ¢è¾“å…¥å¯†ç çš„å¯è§æ€§ã€‚åœ¨å¹•åï¼Œå®ƒä¼šå°†è¾“å…¥ç±»å‹ä» `password` æ›´æ”¹ä¸º `text` ï¼Œåä¹‹äº¦ç„¶ã€‚

ç»„ä»¶ç±»å°†å¯è§æ€§å­˜å‚¨åœ¨å¸ƒå°”å±æ€§ä¸­ï¼š

[source,typescript]
----
public showPassword = false;
----

åœ¨æ¨¡æ¿ä¸­ï¼Œè¾“å…¥ç±»å‹å–å†³äºå±æ€§ï¼ˆç®€åŒ–çš„ä»£ç ï¼‰ï¼š

[source,html]
----
<input [type]="showPassword ? 'text' : 'password'" />
----

æœ€åï¼ŒæŒ‰é’®åˆ‡æ¢å¸ƒå°”å€¼ï¼ˆç®€åŒ–çš„ä»£ç ï¼‰ï¼š

[source,html]
----
<button
  type="button"
  (click)="showPassword = !showPassword"
>
  {{ showPassword ? 'ğŸ”’ Hide password' : 'ğŸ‘ï¸ Show password' }}
</button>
----

ä¸ºäº†æµ‹è¯•è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„è§„èŒƒï¼š

[source,typescript]
----
it('toggles the password display', async () => {
  await setup();

  /* â€¦ */
});
----

æœ€åˆï¼Œè¯¥å­—æ®µå…·æœ‰ `password` ç±»å‹ï¼Œå› æ­¤è¾“å…¥çš„æ–‡æœ¬è¢«æ¨¡ç³ŠåŒ–ã€‚è®©æˆ‘ä»¬æµ‹è¯•è¿™ä¸ªåŸºçº¿ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨å­—æ®µä¸­è¾“å…¥å¯†ç ã€‚è¿™å¹¶ä¸æ˜¯ä¸¥æ ¼å¿…è¦çš„ï¼Œä½†å¯ä»¥ä½¿æµ‹è¯•æ›´åŠ çœŸå®ï¼Œä¹Ÿæ›´å®¹æ˜“è¿›è¡Œè°ƒè¯•ã€‚ï¼ˆå¯†ç å­—æ®µå…·æœ‰æµ‹è¯• id `password`ã€‚ï¼‰

[source,typescript]
----
setFieldValue(fixture, 'password', 'top secret');
----

æˆ‘ä»¬å†æ¬¡é€šè¿‡æµ‹è¯• id æŸ¥æ‰¾è¾“å…¥å…ƒç´ ï¼Œä»¥æ£€æŸ¥å…¶ `type` å±æ€§ã€‚

[source,typescript]
----
const passwordEl = findEl(fixture, 'password');
expect(passwordEl.attributes.type).toBe('password');
----

ç°åœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡å•å‡»åˆ‡æ¢æŒ‰é’®ã€‚æˆ‘ä»¬è®© Angular æ›´æ–° DOMï¼Œå¹¶å†æ¬¡æ£€æŸ¥è¾“å…¥ç±»å‹ã€‚

[source,typescript]
----
click(fixture, 'show-password');
fixture.detectChanges();

expect(passwordEl.attributes.type).toBe('text');
----

æˆ‘ä»¬æœŸæœ›ç±»å‹å·²ç»ä» `password` æ›´æ”¹ä¸º `text`ã€‚å¯†ç ç°åœ¨å¯è§ã€‚

é€šè¿‡ç¬¬äºŒæ¬¡å•å‡»åˆ‡æ¢æŒ‰é’®ï¼Œç±»å‹å°†åˆ‡æ¢å› `password`ã€‚

[source,typescript]
----
click(fixture, 'show-password');
fixture.detectChanges();

expect(passwordEl.attributes.type).toBe('password');
----

è¿™æ˜¯æ•´ä¸ªè§„èŒƒï¼š

[source,typescript]
----
it('toggles the password display', async () => {
  await setup();

  setFieldValue(fixture, 'password', 'top secret');
  const passwordEl = findEl(fixture, 'password');
  expect(passwordEl.attributes.type).toBe('password');

  click(fixture, 'show-password');
  fixture.detectChanges();

  expect(passwordEl.attributes.type).toBe('text');

  click(fixture, 'show-password');
  fixture.detectChanges();

  expect(passwordEl.attributes.type).toBe('password');
});
----

[NOTE]
====
- https://github.com/molily/angular-form-testing/blob/main/client/src/app/components/signup-form/signup-form.component.spec.ts[SignupFormComponent: æµ‹è¯•ä»£ç ]
====

== æµ‹è¯•è¡¨å•çš„å¯è®¿é—®æ€§

Webå¯è®¿é—®æ€§æ„å‘³ç€æ‰€æœ‰äººéƒ½å¯ä»¥ä½¿ç”¨ç½‘ç«™ï¼Œæ— è®ºä»–ä»¬çš„èº«ä½“æˆ–ç²¾ç¥èƒ½åŠ›æˆ–ç½‘ç»œè®¿é—®æŠ€æœ¯å¦‚ä½•ã€‚å®ƒæ˜¯ä¸€ä¸ªç§°ä¸ºåŒ…å®¹æ€§è®¾è®¡çš„æ›´å¤§åŠªåŠ›çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯åˆ›å»ºè€ƒè™‘åˆ°å…·æœ‰ä¸åŒèƒ½åŠ›å’Œéœ€æ±‚çš„äººçš„ä¿¡æ¯ç³»ç»Ÿçš„è¿‡ç¨‹ã€‚

è®¾è®¡Webè¡¨å•æ˜¯ä¸€ä¸ªå¯ç”¨æ€§å’Œå¯è®¿é—®æ€§çš„æŒ‘æˆ˜ã€‚Webè¡¨å•ç»å¸¸å¯¹æ®‹ç–¾äººå’Œè¾…åŠ©æŠ€æœ¯ç”¨æˆ·æ„æˆéšœç¢ã€‚

TIP: å¯è®¿é—®è¡¨å•

æ³¨å†Œè¡¨å•æœ‰å‡ ä¸ªå¯è®¿é—®æ€§ç‰¹å¾ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š

- è¯¥è¡¨å•ç»“æ„è‰¯å¥½ï¼Œå…·æœ‰æ ‡é¢˜ï¼Œ`å­—æ®µé›†(fieldset)` å’Œ `å›¾ä¾‹(legend)` å…ƒç´ ã€‚
- æ‰€æœ‰å­—æ®µéƒ½æœ‰é€‚å½“çš„æ ‡ç­¾ï¼Œä¾‹å¦‚â€œç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰â€ã€‚
- æŸäº›å­—æ®µæœ‰å…¶ä»–æè¿°ã€‚è¿™äº›æè¿°ä¸``aria-describedby``å±æ€§é“¾æ¥ã€‚
- å¿…å¡«å­—æ®µæ ‡æœ‰ `aria-required="true"`ã€‚
- æ— æ•ˆå­—æ®µæ ‡æœ‰ `aria-invalid="true"`ã€‚é”™è¯¯æ¶ˆæ¯ä¸``aria-errormessage``å±æ€§é“¾æ¥ã€‚
- æäº¤è¡¨å•æ—¶ï¼Œä½¿ç”¨ `role="status"` çš„çŠ¶æ€æ¶ˆæ¯é€šçŸ¥ç»“æœã€‚
- ç»“æ„å’Œæ ·å¼æ¸…æ¥šåœ°ä¼ è¾¾äº†å½“å‰ç„¦ç‚¹ä»¥åŠæœ‰æ•ˆçŠ¶æ€ã€‚

TIP: è‡ªåŠ¨åŒ–å¯è®¿é—®æ€§æµ‹è¯•

è¿˜æœ‰è®¸å¤šæˆ‘ä»¬æ²¡æœ‰æåˆ°çš„å¯è®¿é—®æ€§è¦æ±‚å’Œæœ€ä½³å®è·µã€‚ç”±äºæœ¬æŒ‡å—çš„ä¸»è¦ç›®çš„ä¸æ˜¯åˆ›å»ºå¯è®¿é—®çš„è¡¨å•ï¼Œå› æ­¤è®©æˆ‘ä»¬æ¢è®¨å¦‚ä½•**ä»¥è‡ªåŠ¨åŒ–æ–¹å¼æµ‹è¯•å¯è®¿é—®æ€§**ã€‚

æˆ‘ä»¬å·²ç»åœ¨``SignupFormComponent``çš„é›†æˆæµ‹è¯•ä¸­æµ‹è¯•äº†ä¸Šè¿°ä¸€äº›åŠŸèƒ½ã€‚è®©æˆ‘ä»¬ä½¿ç”¨é€‚å½“çš„å·¥å…·æµ‹è¯•å¯è®¿é—®æ€§ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç¼–å†™æ›´å¤šçš„å¯è®¿é—®æ€§éœ€æ±‚è§„èŒƒã€‚

[NOTE]
====
- https://inclusivedesignprinciples.org/[åŒ…å®¹æ€§è®¾è®¡åŸåˆ™]
====

=== pa11y

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹**pa11y**ï¼Œè¿™æ˜¯ä¸€ä¸ªNode.jsç¨‹åºï¼Œç”¨äºæ£€æŸ¥Webé¡µé¢çš„å¯è®¿é—®æ€§ã€‚

TIP: åœ¨Chromeä¸­è¿›è¡Œæµ‹è¯•

pa11yå¯åŠ¨å¹¶è¿œç¨‹æ§åˆ¶Chromeæˆ–Chromiumæµè§ˆå™¨ã€‚æµè§ˆå™¨å¯¼èˆªåˆ°æµ‹è¯•é¡µé¢ã€‚ç„¶åï¼Œpa11yæ³¨å…¥äº†__axe-core__å’Œ__HTML CodeSniffer__ä¸¤ä¸ªå¯è®¿é—®æ€§æµ‹è¯•å¼•æ“ã€‚

è¿™äº›å¼•æ“æ£€æŸ¥æ˜¯å¦ç¬¦åˆWebå†…å®¹å¯è®¿é—®æ€§æŒ‡å—ï¼ˆWCAGï¼‰ï¼Œè¿™æ˜¯Webå¯è®¿é—®æ€§çš„æƒå¨æŠ€æœ¯æ ‡å‡†ã€‚

TIP: CLI vs. CI

pa11yæœ‰ä¸¤ç§æ“ä½œæ¨¡å¼ï¼šé’ˆå¯¹ä¸€ä¸ªWebé¡µé¢çš„å‘½ä»¤è¡Œç•Œé¢ï¼ˆCLIï¼‰å’Œé’ˆå¯¹å¤šä¸ªWebé¡µé¢çš„æŒç»­é›†æˆï¼ˆCIï¼‰æ¨¡å¼ã€‚

è¦å¿«é€Ÿæµ‹è¯•æ‚¨çš„Angularåº”ç”¨ç¨‹åºçš„å•ä¸ªé¡µé¢ï¼Œè¯·ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢ã€‚å®šæœŸæµ‹è¯•æ•´ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œè¯·ä½¿ç”¨æŒç»­é›†æˆæ¨¡å¼ã€‚

è¦ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢ï¼Œè¯·å°†pa11yå®‰è£…ä¸ºå…¨å±€npmæ¨¡å—ï¼š

[source,]
----
npm install -g pa11y
----

TIP: æµ‹è¯•å•ä¸ªé¡µé¢

è¿™å°†å®‰è£…å…¨å±€å‘½ä»¤``pa11y``ã€‚è¦åœ¨æœ¬åœ°Angularå¼€å‘æœåŠ¡å™¨ä¸Šæµ‹è¯•é¡µé¢ï¼Œè¯·è¿è¡Œï¼š

[source,]
----
pa11y http://localhost:4200/
----

å¯¹äºæ³¨å†Œè¡¨å•ï¼Œpa11yæ²¡æœ‰æŠ¥å‘Šä»»ä½•é”™è¯¯ï¼š

[source,]
----
Welcome to Pa11y

 > Running Pa11y on URL http://localhost:4200/

No issues found!
----

TIP: é”™è¯¯æŠ¥å‘Š

å¦‚æœè¡¨å•å­—æ®µä¸­æœ‰ä¸€ä¸ªæ²¡æœ‰æ­£ç¡®çš„æ ‡ç­¾ï¼Œpa11yå°†ä¼šæŠ¥é”™ï¼š

[source,]
----
 â€¢ Error: This textinput element does not have a name available to
   an accessibility API. Valid names are: label element,
   title undefined, aria-label undefined, aria-labelledby undefined.
   â”œâ”€â”€ WCAG2AA.Principle4.Guideline4_1.4_1_2.H91.InputText.Name
   â”œâ”€â”€ html > body > app-root > main > app-signup-form > form > fieldset:nth-child(2) > div:nth-child(2) > p > span > input
   â””â”€â”€ <input _ngcontent-srr-c42="" type="text" formcontrolname="username" â€¦

 â€¢ Error: This form field should be labelled in some way.
   Use the label element (either with a "for" attribute or
   wrapped around the form field), or "title", "aria-label"
   or "aria-labelledby" attributes as appropriate.
   â”œâ”€â”€ WCAG2AA.Principle1.Guideline1_3.1_3_1.F68
   â”œâ”€â”€ html > body > app-root > main > app-signup-form > form > fieldset:nth-child(2) > div:nth-child(2) > p > span > input
   â””â”€â”€ <input _ngcontent-srr-c42="" type="text" formcontrolname="username" â€¦
----

æ¯ä¸ªé”™è¯¯æ¶ˆæ¯éƒ½åŒ…å«äº†è¿åçš„WCAGè§„åˆ™ã€è¿åå…ƒç´ çš„DOMè·¯å¾„å’ŒHTMLä»£ç ã€‚

[NOTE]
====
- https://pa11y.org/[pa11yï¼šæ— éšœç¢æµ‹è¯•å·¥å…·]
- https://github.com/dequelabs/axe-core[axe-coreï¼šè‡ªåŠ¨åŒ–Web UIæµ‹è¯•çš„æ— éšœç¢å¼•æ“]
- https://github.com/squizlabs/HTML_CodeSniffer[HTML CodeSnifferï¼šæ— éšœç¢å®¡è®¡å™¨]
- https://www.w3.org/TR/WCAG21/[Webå†…å®¹æ— éšœç¢æŒ‡å—ï¼ˆWCAGï¼‰2.1]
====

=== pa11y-ci

ä¸ºäº†åœ¨å¼€å‘å’Œæ„å»ºæœåŠ¡å™¨ä¸Šè¿›è¡Œå…¨é¢çš„æµ‹è¯•è¿è¡Œï¼Œæˆ‘ä»¬å°†åœ¨è¿ç»­é›†æˆæ¨¡å¼ä¸‹è®¾ç½®pa11yã€‚

åœ¨æ‚¨çš„Angularé¡¹ç›®ç›®å½•ä¸­ï¼Œå®‰è£…``pa11y-ci``åŒ…ï¼š

[source,]
----
npm install pa11y-ci
----

pa11y-ciæœŸæœ›åœ¨é¡¹ç›®ç›®å½•ä¸­å­˜åœ¨åä¸º `.pa11yci` çš„é…ç½®æ–‡ä»¶ã€‚åˆ›å»ºè¯¥æ–‡ä»¶å¹¶ç²˜è´´ä»¥ä¸‹JSONå†…å®¹:

[source,json]
----
{
  "defaults": {
    "runner": [
      "axe",
      "htmlcs"
    ]
  },
  "urls": [
    "http://localhost:4200"
  ]
}
----

TIP: æµ‹è¯•å¤šä¸ªURL

è¿™ä¸ªé…ç½®å‘Šè¯‰pa11yæ£€æŸ¥URL http://localhost:4200ï¼Œå¹¶ä½¿ç”¨å¯ç”¨çš„æµ‹è¯•å¼•æ“``axe``å’Œ``htmlcs``ã€‚æ‚¨å¯ä»¥å°†è®¸å¤šURLæ·»åŠ åˆ°``urls``æ•°ç»„ä¸­ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œpa11y-ci:

[source,]
----
npx pa11y-ci
----

å¯¹äºæ³¨å†Œè¡¨å•ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

[source,]
----
Running Pa11y on 1 URLs:
> http://localhost:4200 - 0 errors

âœ” 1/1 URLs passed
----

[NOTE]
====
- https://github.com/pa11y/pa11y-ci[pa11y-ciï¼šé¢å‘CIçš„å¯è®¿é—®æ€§æµ‹è¯•è¿è¡Œå™¨]
====

=== å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œpa11y-ci

ä¸Šè¿°é…ç½®æœŸæœ›å¼€å‘æœåŠ¡å™¨å·²åœ¨http://localhost:4200ä¸Šè¿è¡Œã€‚åœ¨å¼€å‘å’Œæ„å»ºæœåŠ¡å™¨ä¸Šéƒ½å¯ä»¥å¯åŠ¨AngularæœåŠ¡å™¨ã€è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•ï¼Œç„¶åå†åœæ­¢æœåŠ¡å™¨ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªæ–¹ä¾¿çš„Node.jsåŒ…``start-server-and-test``æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

[source,]
----
npm install start-server-and-test
----

``start-server-and-test``é¦–å…ˆè¿è¡Œä¸€ä¸ªnpmè„šæœ¬ï¼Œè¯¥è„šæœ¬åº”è¯¥å¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡å™¨ã€‚ç„¶åç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ã€‚ä¸€æ—¦ç»™å®šçš„URLå¯ç”¨ï¼Œå®ƒå°±ä¼šè¿è¡Œå¦ä¸€ä¸ªnpmè„šæœ¬ã€‚

åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªè„šæœ¬æ˜¯``start``ï¼Œå®ƒæ˜¯``ng serve``çš„åˆ«åã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºç¬¬äºŒä¸ªè„šæœ¬æ¥è¿è¡Œ``pa11y-ci``ã€‚

TIP: npmè„šæœ¬

æˆ‘ä»¬ç¼–è¾‘package.jsonï¼Œå¹¶æ·»åŠ ä¸¤ä¸ªè„šæœ¬ï¼š

[source,json]
----
{
  "scripts": {
    "a11y": "start-server-and-test start http-get://localhost:4200/ pa11y-ci",
    "pa11y-ci": "pa11y-ci"
  },
}
----

ç°åœ¨ï¼Œ``npm run a11y``ä¼šå¯åŠ¨Angularå¼€å‘æœåŠ¡å™¨ï¼Œç„¶åè¿è¡Œpa11y-ciï¼Œæœ€ååœæ­¢æœåŠ¡å™¨ã€‚å®¡æ ¸ç»“æœå°†å†™å…¥æ ‡å‡†è¾“å‡ºã€‚

[NOTE]
====
- https://github.com/bahmutov/start-server-and-test[start-server-and-testï¼šå¯åŠ¨æœåŠ¡å™¨ï¼Œç­‰å¾…URLï¼Œç„¶åè¿è¡Œæµ‹è¯•å‘½ä»¤]
====

== è¡¨æ ¼å¯è®¿é—®æ€§ï¼šæ€»ç»“

pa11yæ˜¯ä¸€å¥—åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œæœ‰è®¸å¤šé€‰é¡¹ã€‚æˆ‘ä»¬ä»…ä»…è§¦åŠäº†å®ƒçš„ä¸€äº›ç‰¹ç‚¹ã€‚

è‡ªåŠ¨åŒ–å¯è®¿é—®æ€§æµ‹è¯•æ˜¯å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•çš„æœ‰ä»·å€¼çš„è¡¥å……ã€‚æ‚¨åº”è¯¥å¯¹æ‚¨çš„Angularåº”ç”¨ç¨‹åºçš„é¡µé¢è¿è¡Œåƒpa11yè¿™æ ·çš„å¯è®¿é—®æ€§æµ‹è¯•å™¨ã€‚ç¡®ä¿å¤æ‚è¡¨å•çš„å¯è®¿é—®æ€§ç‰¹åˆ«æœ‰å¸®åŠ©ã€‚

è¯·è®°ä½ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•åªä¼šæŒ‡å‡ºå¯ä»¥ä»¥ç¼–ç¨‹æ–¹å¼æ£€æµ‹åˆ°çš„æŸäº›å¯è®¿é—®æ€§éšœç¢ã€‚

Webå†…å®¹å¯è®¿é—®æ€§æŒ‡å—ï¼ˆWeb Content Accessibility Guidelines -- WCAGï¼‰ä»æŠ½è±¡åˆ°å…·ä½“åœ°å»ºç«‹äº†__åŸåˆ™(principles)__ã€__æŒ‡å—(guidelines)__å’Œ__æˆåŠŸæ ‡å‡†(success criteria)__ã€‚åè€…æ˜¯ä¸€äº›å®é™…è§„åˆ™ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥è‡ªåŠ¨æ£€æŸ¥ã€‚

WCAGçš„æˆåŠŸæ ‡å‡†ä¼´éšç€HTMLã€CSSã€JavaScriptç­‰__æŠ€æœ¯__ã€‚å¯¹äºJavaScript Webåº”ç”¨ç¨‹åºï¼ŒARIAç­‰æŠ€æœ¯ç‰¹åˆ«ç›¸å…³ã€‚

æ€»ä¹‹ï¼Œæ‚¨éœ€è¦å…ˆäº†è§£å¯è®¿é—®æ€§å’ŒåŒ…å®¹æ€§è®¾è®¡ï¼Œåº”ç”¨è§„åˆ™æ¥è®¾è®¡å’Œå®ç°åº”ç”¨ç¨‹åºã€‚ç„¶åæ‰‹åŠ¨å’Œè‡ªåŠ¨æ£€æŸ¥ç¬¦åˆæ€§ã€‚

[NOTE]
====
- https://www.w3.org/TR/WCAG21/[Webå†…å®¹å¯è®¿é—®æ€§æŒ‡å—ï¼ˆWCAGï¼‰2.1]
- https://www.w3.org/WAI/WCAG21/quickref/[å¿«é€Ÿå‚è€ƒï¼šå¦‚ä½•æ»¡è¶³WCAG]
- https://webaim.org/techniques/aria/[WebAIMï¼šARIAä»‹ç»-å¯è®¿é—®çš„å¯Œäº’è”ç½‘åº”ç”¨ç¨‹åº]
- https://www.w3.org/WAI/tutorials/forms/[Webå¯è®¿é—®æ€§æ•™ç¨‹ï¼šè¡¨å•]
====

