<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>代码覆盖率测量 :: Testing Angular</title>
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">Testing Angular</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs-testing-angular" data-version="中文">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">简介</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="target-audience.html">目标受众</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="terminology.html">术语</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-principles.html">测试原则</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="example-applications.html">示例应用程序</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="angular-testing-principles.html">Angular 测试原则</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="test-suites-with-jasmine.html">使用Jasmine编写测试套件</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faking-dependencies.html">伪造依赖</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="debugging-tests.html">调试测试</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-components.html">测试组件</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-components-with-children.html">测试带有子组件的组件</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-components-depending-on-services.html">测试依赖于服务的组件</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-complex-forms.html">测试复杂表单</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-components-with-spectator.html">测试时使用Spectator库简化组件</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-services.html">测试服务</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-pipes.html">测试管道</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-directives.html">测试指令</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-modules.html">测试模块</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="measuring-code-coverage.html">代码覆盖率测量</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="end-to-end-testing.html">端到端测试</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="summary.html">总结</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index-of-example-applications.html">示例应用程序索引</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="references.html">参考资料</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acknowledgements.html">鸣谢</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="about.html">关于</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="license.html">许可证</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="other.html">其它</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Testing Angular</span>
    <span class="version">中文</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="start.html">Testing Angular</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="start.html">中文</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="start.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="start.html">Testing Angular</a></li>
    <li><a href="measuring-code-coverage.html">代码覆盖率测量</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="目录" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">代码覆盖率测量</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>学习目标</p>
</div>
<div class="ulist">
<ul>
<li>
<p>了解代码覆盖率指标</p>
</li>
<li>
<p>生成和检查代码覆盖率报告</p>
</li>
<li>
<p>找到尚未被自动化测试覆盖的代码</p>
</li>
<li>
<p>强制执行代码覆盖率阈值和提高代码覆盖率</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>代码覆盖率（也称为测试覆盖率）告诉您通过运行单元测试和集成测试来执行的代码部分。代码覆盖率通常以百分比形式表示，例如，79％语句，53％分支，74％函数，78％行数。</p>
</div>
<div class="paragraph">
<p>语句广义上是控制结构，例如<code>if</code>和<code>for</code>，以及由分号分隔的表达式。分支是指 <code>if (…) {…} else {…}</code> 和 <code>… ? … : …</code> 条件的两个分支。函数和行不言自明。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_覆盖率报告"><a class="anchor" href="#_覆盖率报告"></a>覆盖率报告</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在Angular的Karma和Jasmine设置中，使用 <a href="https://istanbul.js.org/">伊斯坦布尔(Istanbul)</a> 来测量测试覆盖率。Istanbul重写要测试的代码，记录是否调用了语句、分支、函数和行。然后它生成一个全面的测试报告。</p>
</div>
<div class="paragraph">
<p>要在运行测试时激活Istanbul，请添加<code>--code-coverage</code>参数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ng test --code-coverage</code></pre>
</div>
</div>
<div class="paragraph">
<p>在测试完成后，Istanbul会将报告保存在位于Angular项目目录下的<code>coverage</code>目录中。</p>
</div>
<div class="paragraph">
<p>该报告是一组HTML文件，您可以使用浏览器打开。首先，在您选择的浏览器中打开<code>coverage/index.html</code>文件。</p>
</div>
<div class="paragraph">
<p>Flickr搜索示例的报告如下所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/code-coverage-flickr-search.png" alt="code coverage flickr search">
</div>
</div>
<div class="paragraph">
<p>Istanbul为每个目录和每个文件创建了一个HTML页面。通过跟随链接，您可以查看每个文件的报告。</p>
</div>
<div class="paragraph">
<p>例如，Flickr搜索的 <a href="https://github.com/9elements/angular-flickr-search/blob/main/src/app/components/photo-item/photo-item.component.ts">photo-item.component.ts</a> 的覆盖率报告如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/code-coverage-photo-item.png" alt="code coverage photo item">
</div>
</div>
<div class="paragraph">
<p>报告呈现了带有调用次数信息的源代码注释。在上面的示例中，除了一个不相关的<code>else</code>分支（用“E”标记）之外，代码完全被覆盖。</p>
</div>
<div class="paragraph">
<p>规范 <code>it('focusses a photo on click', () &#8658; {…})</code> 在点击照片项来测试<code>focusPhoto</code>输出是否发出。让我们故意禁用这个规范，以查看影响。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/code-coverage-photo-item-uncovered.png" alt="code coverage photo item uncovered">
</div>
</div>
<div class="paragraph">
<p>从上面的覆盖率报告中可以看出，<code>handleClick</code>方法从未被调用过。一个关键的组件行为没有进行测试。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_如何使用覆盖率报告"><a class="anchor" href="#_如何使用覆盖率报告"></a>如何使用覆盖率报告</h2>
<div class="sectionbody">
<div class="paragraph">
<p>现在我们知道如何生成报告，那么我们应该如何使用它呢？</p>
</div>
<div class="paragraph">
<p>在章节 <a href="testing-principles.html#_适量的测试" class="xref page">适量的测试</a> 中，我们已经确定了代码覆盖率作为一个有用但存在缺陷的度量标准。作为一种定量的指标，代码覆盖率无法评估测试的质量。</p>
</div>
<div class="paragraph">
<p>软件测试不是一场竞赛。我们不应该为了得分而努力达到某个特定的分数。那么我们测量代码覆盖率的目的是什么呢？</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
找到未覆盖的代码
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>覆盖率报告是一个有价值的工具，你在编写测试时应该使用它。它 <em>揭示了尚未进行测试的代码行为</em>。该报告不仅指导您的测试，还加深了您对测试工作原理的理解。</p>
</div>
<div class="paragraph">
<p>无论您当前的覆盖率得分是多少，都可以使用报告来监控和改进您的测试实践。如 <a href="testing-principles.html#_调整测试方法" class="xref page">定制您的测试方法</a> 中所述，测试应该是开发例程的一部分。新功能应包括测试，错误修复应包括一个测试作为证明和防止回归的手段。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
提高覆盖率
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>编写新代码和修改现有代码不应降低覆盖率得分，而是逐步增加。这意味着如果您现有的测试覆盖了75%的代码行数，新代码需要至少有75%的覆盖率。否则，得分会逐渐下降。</p>
</div>
<div class="paragraph">
<p>在持续集成环境中运行单元测试和集成测试，并测量代码覆盖率是常见做法。为了强制执行特定的覆盖率得分并防止下降，您可以在 <a href="angular-testing-principles.html#_配置karma和jasmine" class="xref page">Karma配置</a> 中配置阈值。</p>
</div>
<div class="paragraph">
<p>在<code>karma.conf.js</code>中，您可以为语句、分支、函数和行添加全局阈值。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">coverageReporter: {
  /* … */
  check: {
    global: {
      statements: 75,
      branches: 75,
      functions: 75,
      lines: 75,
    },
  },
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>在上述配置中，所有的值都设置为75%。如果覆盖率低于这个数字，即使所有的规范都通过了，测试执行也会失败。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
提高标准
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>当新的代码添加到项目中，并且测试覆盖率优于平均水平时，您可以逐渐提高阈值，例如从<code>75</code>提高到<code>75.1</code>、<code>75.2</code>、<code>75.3</code>等等。很快，这些小的改进将累积起来。</p>
</div>
<div class="paragraph">
<p>测试覆盖率不应该是一个毫无意义的竞争，它给开发人员带来压力，并让那些未达到任意标准的人感到羞耻。测量覆盖率应该是一个可以为您自己获益的工具。请记住，编写有意义、准确的测试并不一定会增加覆盖率得分。</p>
</div>
<div class="paragraph">
<p>对于初学者和专家来说，覆盖率报告有助于设置、调试和改进他们的测试。对于经验丰富的开发人员，得分有助于保持稳定的测试实践。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/karma-runner/karma-coverage/blob/master/docs/configuration.md">karma-coverage配置</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
